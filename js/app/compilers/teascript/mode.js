define(function(require,exports,module){var e,t,n,r,i,o,s,a,l,c,u,h,d,p,f,m,g,v,y,b,C,w,A,x,E,_,S,T,F,D,k,M,R,L,B,O,N,I,$,P,j,W,z,H,U,q,K,V,G,J,X,Y,Q,Z,et,tt,nt,rt,it,ot,st,at,lt,ct,ut,ht,dt,pt,ft,mt,gt,vt,yt,bt,Ct,wt,At,xt,Et,_t,St,Tt,Ft,Dt,kt,Mt,Rt,Lt,Bt,Ot,Nt,It,$t,Pt,jt,Wt,zt,Ht,Ut,qt,Kt,Vt,Gt,Jt,Xt,Yt,Qt,Zt,en,tn,nn,rn,on,sn,an,ln,cn,un,hn,dn,pn,fn,mn,gn,vn,yn,bn,Cn,wn,An,xn,En,_n,Sn,Tn,Fn,Dn,kn,Mn,Rn,Ln,Bn,On,Nn,In,$n,Pn,jn,Wn,zn,Hn,Un,qn,Kn,Vn,Gn,Jn,Xn,Yn,Qn,Zn,er,tr,nr,rr,ir,or,sr,ar,lr,cr,ur,hr,dr,pr,fr,mr,gr,vr,yr,br,Cr,wr,Ar,xr=module.uri||"",Er=(xr.substring(0,xr.lastIndexOf("/")+1),function(e,t){return function(){return e.apply(t,arguments)}}),_r={}.hasOwnProperty,Sr=function(e,t){function n(){this.constructor=e}for(var r in t)_r.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},Tr=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},Fr=[].slice;v=require("ace/ace"),f=require("ace/range").Range,g=require("ace/mode/text").Mode,t=require("ace/mode/behaviour").Behaviour,m=require("ace/selection").Selection,pn=require("ace/lib/oop"),a=require("ace/lib/event_emitter").EventEmitter,u=require("ace/keyboard/hash_handler").HashHandler,r=require("./CustomAutocomplete"),i=require("./CustomSearchBox"),n=require("./CombinedTooltip"),s=require("app/DistributingWorkerClient"),tn=function(e){return console.log(e),e},vr=$=require("./compiler"),Lt=vr.isForm,Tt=vr.isCall,Ht=vr.isNotCapital,P=vr.concat,nn=vr.map,j=vr.concatMap,lr=vr.zipWith,sr=vr.unzip,nt=vr.filter,Qt=vr.join,y=vr.all,cr=vr.__,zn=vr.sortedArgs,mn=vr.originOf,pr=vr._is,mr=vr._notEmpty,hr=vr._empty,gr=vr._operator,ur=vr._arguments,Cr=vr._terms,Ar=vr._validTerms,yr=vr._snd,dr=vr._fst,fr=vr._labelName,br=vr._symbol,k=vr.call_,ir=vr.token_,function(){var e,t;return e=this.fromOrientedRange,this.fromOrientedRange=function(t){return e.call(this,t),this.$nodes=t.$nodes,this.$editing=t.$editing,this.$editMarker=t.$editMarker},t=this.toOrientedRange,this.toOrientedRange=function(e){return e=t.call(this,e),e.$nodes=this.$nodes,e.$editing=this.$editing,e.$editMarker=this.$editMarker,e}}.call(m.prototype),exports.Mode=function(t){function m(e,t){this.isSingleLineInput=e,this.editorInstance=t,this.handleRangeDeselect=Er(this.handleRangeDeselect,this),this.handleCommandExecution=Er(this.handleCommandExecution,this),this.replay=Er(this.replay,this),this.removeMultiSelectKeyboardHandler=Er(this.removeMultiSelectKeyboardHandler,this),this.addMultiSelectKeyboardHandler=Er(this.addMultiSelectKeyboardHandler,this),this.createMultiSelectKeyboardHandler=Er(this.createMultiSelectKeyboardHandler,this),this.handlePaste=Er(this.handlePaste,this),this.handleCopy=Er(this.handleCopy,this),this.handleClick=Er(this.handleClick,this),this.handleMouseUp=Er(this.handleMouseUp,this),this.handleMouseDown=Er(this.handleMouseDown,this),this.detach=Er(this.detach,this),this.closeTooltip=Er(this.closeTooltip,this),this.docsTooltip=Er(this.docsTooltip,this),this.createCompleter=Er(this.createCompleter,this),this.tokensOnLine=Er(this.tokensOnLine,this),this.$tokenizer={getLineTokens:function(e){return function(t,n,r,i){var o;return null==i&&(i=e.editor.session.getDocument()),(o=e.tokensOnLine(r,i))?{tokens:z(o)}:{tokens:[{value:t,type:"text"}]}}}(this)},pn.implement(this.$tokenizer,a),this.$behaviour=void 0,this.completers=[this.completer=this.createCompleter()]}var g,v,y;return Sr(m,t),m.prototype.tokensOnLine=function(e,t){var n,r;return r=t.positionToIndex({row:e,column:0}),n=t.positionToIndex({row:e+1,column:0}),this.ast?ct(or(this.ast),r,n):void 0},m.prototype.getTokenAt=function(e){var t,n,r;return r=this.tokensSurroundingPos(e),n=r[0],t=r[1],t&&Rt(t)?t:n||t},m.prototype.getNextLineIndent=function(e,t,n){var r,i,o;return r=this.$getIndent(t),o=(t.match(/[\(\[\{]/g)||[]).length,i=(t.match(/[\)\]\}]/g)||[]).length,new Array(o-i+r.length/n.length+1).join(n)},g=/^(\s*)# ?/,v=/^\s*###(?!#)/,y=/^\s*/,m.prototype.toggleCommentLines=function(e,t,n,r){var i,o,s,a;for(s=new f(0,0,0,0),i=a=n;r>=n?r>=a:a>=r;i=r>=n?++a:--a)o=t.getLine(i),v.test(o)||(o=g.test(o)?o.replace(g,"$1"):o.replace(y,"$&# "),s.end.row=s.start.row=i,s.end.column=o.length+2,t.replace(s,o))},m.prototype.detachFromSession=function(){return this.editor.removeListener("mousedown",this.handleMouseDown),this.editor.removeListener("mouseup",this.handleMouseUp),this.editor.tokenTooltip.destroy(),this.editor.onPaste=this.__editorOnPaste,this.editor.getCopyText=this.__editorCopyText,this.editor.setOption("dragEnabled",!0),this.editor.setOption("enableBlockSelect",!0)},m.prototype.attachToEditor=function(e){var t;return t=e.session,this.editor=e,this.editor.completers=this.completers,this.editor.session.setUndoManager(this.createUndoManager()),e.setOption("dragEnabled",!1),e.setOption("enableBlockSelect",!1),this.editor.on("mousedown",this.handleMouseDown),this.editor.on("mouseup",this.handleMouseUp),this.editor.tokenTooltip=new n(this.editor),this.editor.tokenTooltip.setTooltipContentForToken=this.docsTooltip,this.__editorOnPaste=this.editor.onPaste,this.editor.onPaste=this.handlePaste,this.__editorCopyText=this.editor.getCopyText,this.editor.getCopyText=this.handleCopy,this.editor.selection.on("removeRange",this.handleRangeDeselect),this.editor.commands.on("afterExec",this.handleCommandExecution),this.createMultiSelectKeyboardHandler(),t.multiSelect.on("multiSelect",this.addMultiSelectKeyboardHandler),t.multiSelect.on("singleSelect",this.removeMultiSelectKeyboardHandler),this.editor.on("blur",this.detach),this.isSingleLineInput||this.addVerticalCommands(t),this.addCommands(t),this.initAst("")},m.prototype.setContent=function(e,t,n){var r,i,o;try{return null!=n&&this.reportModuleName(n),r=E(e,this.ast),o=xt(this.ast),this.mutate(et({changeInTree:{added:r,at:o}},t?{selectionRange:t}:{tangibleSelection:{"in":r,out:o.out}})),this.handleCommandExecution()}catch(s){return i=s,console.error(i,i.stack),console.error(e),this.editor.insert(e)}},m.prototype.selectInitially=function(e){return this.initialSelection=e},m.prototype.tangibleSelectionFromRange=function(e){var t,n,r,i;return r=this.tangibleAtPos(e.start),t=this.tangibleAtPos(e.end),mr(r["in"])?(n=R(r["in"][0]),i=R(t.out[0]),{"in":Cn(r).slice(n,i),out:t.out}):t},m.prototype.initAst=function(e){return this.ast=this.isSingleLineInput?$.astizeExpressionWithWrapper(e):$.astizeList(e),""===e?this.mutate({tangibleSelection:xt(this.ast)}):void 0},m.prototype.updateAst=function(e,t){var n;return null==t&&(t=[]),K(e,this.ast),this.$tokenizer._signal("update",{data:{rows:{first:1}}}),(hr(t)||!this.isAutocompleting())&&this.updateAutocomplete(),this.addErrorMarkers(t),(n=this.initialSelection)?(this.initialSelection=null,this.mutate({inSelection:at(n.name,this.ast)})):void 0},m.prototype.repositionAst=function(){var e,t,n,r,i,o,s,a;for(e=this.ast.start,s=[[this.ast,!0]],a=[];n=s.pop();)r=n[0],o=n[1],Lt(r)?o?(r.start=e,s.push([r,!1]),a.push(function(){var e,n;for(n=[],e=r.length-1;e>=0;e+=-1)t=r[e],n.push(s.push([t,!0]));return n}())):a.push(r.end=e):(i=e-r.start,r.start=e,r.end+=i,a.push(e=r.end));return a},m.prototype.addErrorMarkers=function(e){var t,n,r,i,o,s,a,l;return this.removeErrorMarkers(),this.errorMarkers=[],n=e[0],n&&(i=n.message,t=n.conflicts,i)?(this.errorMarkers=function(){var e,n,i;for(i=[],r=e=0,n=t.length;n>e;r=++e)l=t[r],l&&(s=mn(l))&&(a=wr(s),o=lt(this.ast,a.start,a.end)[0],i.push({node:o}));return i}.call(this),this.updateErrorMarkers()):void 0},m.prototype.updateErrorMarkers=function(){var e,t,n,r,i,o,s,a;for(this.removeErrorMarkers(),s=this.errorMarkers||[],a=[],i=0,o=s.length;o>i;i++)t=s[i],t.node&&(n=t.node,r=this.nodeRange(n),e=this.errorMarkerRange(r),a.push(t.id=this.editor.session.addMarker(e,"clazz",this.showError(r,e,n.tea),!0)));return a},m.prototype.removeErrorMarkers=function(){var e,t,n,r,i;for(r=this.errorMarkers||[],i=[],t=0,n=r.length;n>t;t++)e=r[t].id,e&&i.push(this.editor.session.removeMarker(e));return i},m.prototype.showError=function(e,t,n){var r;return r=function(){return function(n,r,i,o,s,a){var l;return l=e.isMultiLine()?" golem_error-origin-open":"",a.drawSingleLineMarker(n,t,"golem_error-origin"+l,s)}}(this),r.type=n,r},m.prototype.errorMarkerRange=function(e){var t;return e.isMultiLine()?(t=e.start.row,new f(t,e.start.column,t,this.editor.session.getScreenLastRowColumn(t))):e},m.prototype.doAutocomplete=function(e){var t,n,r,i;return n=this.editor,r=["Up","Down","Ctrl-Up|Ctrl-Home","Ctrl-Down|Ctrl-End","PageUp","PageDown"],(null!=e?e.command.autocomplete:void 0)&&((t=this.editedAtom())&&!Nt(t)&&!Ut(t)&&this.offsetToCursor(t)===t.symbol.length||this.isInserting())?this.openAutocomplete():n.completer&&(i=null!=e?e.command.name:void 0,Tr.call(r,i)<0||t&&Ut(t))?n.completer.detach():void 0},m.prototype.openAutocomplete=function(){var e;return e=this.editor,!this.isAutocompleting()||this.isInserting()?(e.completer||(e.completer=new r(!this.isSingleLineInput)),this.closeTooltip(),e.completer.showPopup(e)):void 0},m.prototype.updateAutocomplete=function(){var e;return this.isAutocompleting()?this.editor.completer.updateCompletions():this.editor.isFocused()&&(this.isInserting()||(e=this.onlySelectedExpression())&&!e.tea)?this.openAutocomplete():void 0},m.prototype.isAutocompleting=function(){return this.editor.completer&&this.editor.completer.activated},m.prototype.createCompleter=function(){var e;return e={getCompletions:function(t){return function(n,r,i,o,s){var a,l,c,u,h,d;if(!(o&&(null!=(h=n.completer.completions)?h.filtered.length:void 0)>0))return c=r.getMode(),c.isEditing()?(u=c.editedAtom(),a=u.symbol):u=nr(c.selectedTangible()),!u.tea||u.tea.ForAll||(null!=(d=u.assignable)?d.top:0)?u.inferredType?t.worker.call("availableTypes",[u.inferredType],function(t){var n,r,i;return s(null,function(){var o,s;s=[];for(r in t)o=t[r],i=o.type,n=o.docs,s.push({name:i,value:i,completer:e,docs:n});return s}())}):void s("error",[]):(l={type:u.tea,scope:u.scope,pattern:u.assignable,emptyCall:Mt(u.parent)},t.worker.call("matchingDefinitions",[l],function(t){var n,r,i,o,a,l;return s(null,function(){var s,c;c=[];for(a in t)s=t[a],l=s.type,o=s.score,i=s.rawType,n=s.arity,r=s.docs,c.push({name:a,value:a,completer:e,score:o,meta:l,rawType:i,arity:n,docs:r});return c}())}))}}(this),getDocTooltip:function(e){return function(t){t.rawType&&!t.docHTML&&(t.docHTML=e.createDocTooltipHtml(t))}}(this),insertMatch:function(){return function(e,t){var n,r,i;return i=t.value,n=e.session.getMode(),n.startGroupMutation(),n.removeSelected(),n.insertStringForward(i),Lt(r=n.onlySelectedExpression())&&n.mutate({tangibleSelection:ft(c,r)}),n.finishGroupMutation()}}(this)}},m.prototype.docsTooltip=function(e,t){var n,r,i,o,s;return n=function(e){return function(n){return t.setHtml(n),t.open(),e.activeTooltip=t}}(this),t.hideAndRemoveMarker(),(r=e.malformed)||Dt(e)&&(r=e.parent.malformed)?n(r):null!=e.scope?(i={name:e.symbol,scope:e.scope},this.worker.call("docsFor",[i],function(t){return function(r){return null!=r?n("name"===e.label&&r.rawType?t.prettyPrintTypeForDoc(r):t.createDocTooltipHtml(r)):void 0}}(this))):(o=(null!=(s=e.type)?s.type:void 0)||e.tea)?n(this.prettyPrintTypeForDoc({rawType:o})):void 0},m.prototype.lookupSource=function(e,t){var n;return n={name:e.symbol,scope:e.scope},this.worker.call("docsFor",[n],function(){return function(e){var n,r,i,o,s;return o=e.source,Bt(o)&&(s=Cr(o),n=s[0],r=s[1],i=3<=s.length?Fr.call(s,2):[],o=k(n,Qt([r],nt(Ot,i)))),t(Q(o))}}(this))},m.prototype.closeTooltip=function(){return this.detach()},m.prototype.detach=function(){var e;return null!=(e=this.activeTooltip)?e.hideAndRemoveMarker():void 0},m.prototype.createDocTooltipHtml=function(e){var t;return"<span style='color: #9EE062'>"+e.name+"</span>"+(e.arity?(t=e.arity||[]," <span style='color: #9C49B6'>"+t.join(" ")+"</span>"):"")+"\n"+(e.rawType?""+this.prettyPrintTypeForDoc(e)+"\n":"")+(e.docs?$.labelDocs(e.docs,t):"")},m.prototype.prettyPrintTypeForDoc=function(e){var t;return t=e.rawType,$.prettyPrint(t)},m.prototype.handleMouseDown=function(){return this.mouseDownTime=+new Date},m.prototype.handleMouseUp=function(e){return e.duration=new Date-this.mouseDownTime,e.preventDefault(),this.handleClick(e)},m.prototype.handleClick=function(e){var t;return t=200,e.duration>t?this.editor.execCommand("edit by click"):e.domEvent.shiftKey?this.editor.execCommand("expand selection by click"):this.ast?this.editor.execCommand("select by click"):void 0},m.prototype.handleCopy=function(){var e,t;return t=this.editor.getSelectedText(),e=q(nr(this.selectedTangible())),e>0?t.replace(new RegExp("\\n"+Array(2*e+1).join(" "),"g"),"\n"):t},m.prototype.handlePaste=function(e){var t,n;return t=e.split(/(?:\r\n|\r|\n)(?!\s)/),n=this.editor.selection.rangeList.ranges,t.length>n.length||t.length<2||!t[1]?this.editor.commands.exec("insertstring",this.editor,e):(this.startGroupMutation(),this.editor.forEachSelection({exec:function(e){return function(){return e.insertStringForward(t[e.editor.selection.index])}}(this)}),this.finishGroupMutation(),this.handleCommandExecution({command:{name:"paste"}}))},m.prototype.undoManager=function(){var e;return e=this.editor.session.getUndoManager()},m.prototype.createUndoManager=function(){return new o(this)},m.prototype.addVerticalCommands=function(){return this.editor.commands.addCommands({"move up to atom or position":{bindKey:{win:"Up",mac:"Up"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectLineAdjecentAtomOrPosition(p)}}(this)},"move down to atom or position":{bindKey:{win:"Down",mac:"Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectLineAdjecentAtomOrPosition(d)}}(this)},"add a new sibling expression on the next line":{bindKey:{win:"Enter",mac:"Enter"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.replaceSpace(c,"\n")}}(this)},"add a new sibling expression on the previous line":{bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},multiSelectAction:"forEach",exec:function(t){return function(){return t.replaceSpace(e,"\n")}}(this)},"select the next reference of selection":{bindKey:{win:"Tab",mac:"Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(e){return function(){return e.selectReferenceInDirection(c)}}(this)},"select the previous reference of selection":{bindKey:{win:"Shift-Tab",mac:"Shift-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(t){return function(){return t.selectReferenceInDirection(e)}}(this)}})},m.prototype.createMultiSelectKeyboardHandler=function(){return this.multiSelectKeyboardHandler=new u([{name:"escape multi select",bindKey:"esc",scrollIntoView:"cursor",readonly:!0,exec:function(e){return function(){var t,n,r;return n=e.editor.selection,r=n.ranges,t=r[r.length-1],n.toSingleRange(t)}}(this),isAvailable:function(e){return function(){return e.isMultiSelecting()}}(this)}])},m.prototype.addMultiSelectKeyboardHandler=function(){return this.editor.keyBinding.addKeyboardHandler(this.multiSelectKeyboardHandler)},m.prototype.removeMultiSelectKeyboardHandler=function(){return this.editor.keyBinding.removeKeyboardHandler(this.multiSelectKeyboardHandler)},m.prototype.addCommands=function(){return this.editor.commands.addCommands({insertstring:{multiSelectAction:"forEach",scrollIntoView:"cursor",autocomplete:!0,exec:function(e){return function(t,n){return e.insertStringForward(n)}}(this)}}),this.editor.commands.addCommands(this.commands={ignoretheseshortcuts:{bindKey:{win:"Ctrl-Shift-E",mac:"Ctrl-Shift-E|Command-G|Command-Shift-G|Ctrl-G|Ctrl-Shift-G|Command-Shift-Up|Shift-Up|Shift-Down|Ctrl-N|Option-Shift-Left|Option-Shift-Right|Command-Shift-Left|Command-Shift-Right|Ctrl-B|Ctrl-V|Command-Option-E|Command-Shift-E|Command-D|Command-Shift-D duplicateSelection|Command-Alt-S|Command-/|Command-Shift-/|Command-Option-Up|Command-Option-Down|Command-Delete|Ctrl-H|Alt-Delete|Alt-Backspace|Ctrl-Alt-Backspace|Ctrl-[|Ctrl-]|Ctrl-Shift-U|Command-Shift-L|Ctrl-Alt-Up|Ctrl-Alt-Down|Ctrl-Alt-Shift-Up|Ctrl-Alt-Shift-Down|Ctrl-Alt-Left|Ctrl-Alt-Right|Ctrl-Alt-Shift-Left|Ctrl-Alt-Shift-Right|Ctrl-Alt-L|Ctrl-Alt-A|Ctrl-Alt-G"},exec:function(){return function(){}}(this)},"select by click":{autocomplete:!0,exec:function(e){return function(){return e.mutate({tangibleSelection:e.tangibleAtPos(e.cursorPosition())})}}(this)},"edit by click":{multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t,n;return n=e.tangibleAtPos(e.cursorPosition()),t=dn(n),e.mutate(t&&Et(t)?{withinAtom:t,withinAtomPos:e.offsetToCursor(t)}:{tangibleSelection:n})}}(this)},"expand selection by click":{multiSelectAction:"forEach",exec:function(e){return function(){var t,n,r;return r=$n([e.selectedTangible(),e.tangibleAtPos(e.cursorPosition())]),t=r[0],n=r[1],e.mutate({tangibleSelection:qn(t,n)})}}(this)},cut:{scrollIntoView:"cursor",multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t;return t=e.editor.getSelectionRange(),e.editor._emit("cut",t),e.remove(c)}}(this)},find:{bindKey:{win:"Ctrl-Shift-F",mac:"Command-F"},readOnly:!0,exec:function(e){return function(){return e.isSingleLineInput?void 0:i.Search(e.editor)}}(this)},selectall:{bindKey:{win:"Ctrl-A",mac:"Command-A"},readOnly:!0,exec:function(e){return function(){return e.mutate({tangibleSelection:xt(e.ast)})}}(this)},"select enclosing expression":{bindKey:{win:"Ctrl-Up",mac:"Command-Up"},multiSelectAction:"forEach",exec:function(e){return function(){return e.mutate({inSelection:e.isEditing()?e.editedAtom():e.realParentOfSelected()})}}(this)},"select the first expression inside selection":{bindKey:{win:"Ctrl-Down",mac:"Command-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveDown(l,h)}}(this)},"select the last expression inside selection":{bindKey:{win:"Ctrl-Shift-Down",mac:"Command-Shift-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveDown(h,l)}}(this)},"move to next atom or position":{bindKey:{win:"Right",mac:"Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectFollowingAtomOrPosition(d)}}(this)},"move to previous atom or position":{bindKey:{win:"Left",mac:"Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectFollowingAtomOrPosition(p)}}(this)},"select next sibling expression":{bindKey:{win:"Ctrl-Right",mac:"Command-Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectSibling(d)}}(this)},"select previous sibling expression":{bindKey:{win:"Ctrl-Left",mac:"Command-Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectSibling(p)}}(this)},"include next expression in selection":{bindKey:{win:"Shift-Right",mac:"Shift-Right"},multiSelectAction:"forEach",exec:function(e){return function(){return e.expandSelection(d)}}(this)},"include previous expression in selection":{bindKey:{win:"Shift-Left",mac:"Shift-Left"},multiSelectAction:"forEach",exec:function(e){return function(){return e.expandSelection(p)}}(this)},"add new sibling expression":{bindKey:{win:"Space",mac:"Space"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertSpace(c," ")}}(this)},"add new sibling expression before current":{bindKey:{win:"Shift-Space",mac:"Shift-Space"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.insertSpace(e," ")}}(this)},removeback:{bindKey:{win:"Backspace",mac:"Backspace"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.remove(e)}}(this)},removeforward:{bindKey:{win:"Delete",mac:"Delete|Shift-Delete|Ctrl-Backspace|Shift-Backspace"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.remove(c)}}(this)},"flatten onto a single line":{bindKey:{win:"Ctrl-Space",mac:"Ctrl-Space"},multiSelectAction:"forEach",exec:function(e){return function(){return e.removeNewLines()}}(this)},"jump to next occurence of the selection":{bindKey:{win:"Ctrl-Tab",mac:"Alt-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(e){return function(){return e.selectOccurenceInDirection(c)}}(this)},"jump to previous occurence of the selection":{bindKey:{win:"Ctrl-Shift-Tab",mac:"Alt-Shift-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(t){return function(){return t.selectOccurenceInDirection(e)}}(this)},"multiselect next reference":{bindKey:{win:"Ctrl-S",mac:"Ctrl-S"},scrollIntoView:"center",exec:function(e){return function(){return e.multiSelectReferenceInDirection(c)}}(this)},"multiselect previous reference":{bindKey:{win:"Ctrl-Shift-S",mac:"Ctrl-Shift-S"},scrollIntoView:"center",exec:function(t){return function(){return t.multiSelectReferenceInDirection(e)}}(this)},"shift expression backward":{bindKey:{win:"Alt-Left",mac:"Alt-Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.moveSelection(e)}}(this)},"shift expression forward":{bindKey:{win:"Alt-Right",mac:"Alt-Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveSelection(c)}}(this)},"shift all expressions on a line up":{bindKey:{win:"Alt-Up",mac:"Alt-Up"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.moveSelectionByLine(e)}}(this)},"shift all expressions on a line down":{bindKey:{win:"Alt-Down",mac:"Alt-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveSelectionByLine(c)}}(this)},"insert a character":{bindKey:{win:"\\",mac:"\\"},multiSelectAction:"forEach",exec:function(e){return function(){return e.insertStringForward(e.isEditingHalfDelimited()?"\\":"\\_")}}(this)},"wrap in a call":{bindKey:{win:"Ctrl-Shift-9",mac:"Command-Shift-9"},logicalKey:{win:"Ctrl-(",mac:"Command-("},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.wrap("(",{insert:!0}," ",{selected:!0},")")}}(this)},"wrap in parentheses":{bindKey:{win:"(",mac:"("},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("(",")")}}(this)},"wrap in brackets":{bindKey:{win:"[",mac:"["},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("[","]")}}(this)},"wrap in braces":{bindKey:{win:"{",mac:"{"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("{","}")}}(this)},"insert or surround by quotes":{bindKey:{win:'"',mac:'"'},multiSelectAction:"forEach",exec:function(e){return function(){var t,n;return e.isEditingHalfDelimited()?"string"===(t=e.editedAtom()).label&&e.isAtLimit(c,t)?e.mutate({inSelection:t}):e.insertStringForward('"'):(n=Z('"',e.selectedText()),t=E('"'+n+'"',e.parentOfSelected())[0],e.mutate(et({changeInTree:{added:[t],at:e.selectedTangible()}},e.isSelecting()?{inSelection:t}:{withinAtom:t,withinAtomPos:n.length+1})))}}(this)},"select enclosing form or insert )":{bindKey:{win:")",mac:")"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert(")")}}(this)},"select enclosing form or insert }":{bindKey:{win:"}",mac:"}"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert("}")}}(this)},"select enclosing form or insert ]":{bindKey:{win:"]",mac:"]"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert("]")}}(this)},"increment a number":{bindKey:{win:"Ctrl-Shift-Up",mac:"Alt-Shift-Up"},multiSelectAction:"forEach",exec:function(e){return function(){return e.changeNumerical(1)}}(this)},"decrement a number":{bindKey:{win:"Ctrl-Shift-Down",mac:"Alt-Shift-Down"},multiSelectAction:"forEach",exec:function(e){return function(){return e.changeNumerical(-1)}}(this)},"select enclosing definition":{bindKey:{win:"Ctrl-Shift-0",mac:"Command-Shift-0"},logicalKey:{win:"Ctrl-)",mac:"Command-)"},multiSelectAction:"forEach",exec:function(e){return function(){return e.mutate({inSelection:U(ln(l,e.selectedTangible()))})}}(this)},addlabel:{bindKey:{win:":",mac:":"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t,n,r,i;return e.isSingleLineInput&&""===e.editor.getValue()?!1:e.isEditingHalfDelimited()?e.insertStringForward(":"):(t=e.onlySelectedExpression(),e.mutate(e.isEditing()||t&&Et(t)?(n=t.symbol.length,{changeWithinAtom:{string:":",atom:t,range:[n,n]}}):(i=E(":",e.parentOfSelected()),r=i[0],i,{changeInTree:{added:[r],at:e.selectedTangible()},withinAtom:r,withinAtomPos:0})))}}(this)},"insert a comment":{bindKey:{win:"#",mac:"#"},multiSelectAction:"forEach",exec:function(e){return function(){return e.isEditingHalfDelimited()?e.insertStringForward("#"):e.wrap("(","#"," ",{selected:!0,select:!0},")")}}(this)},"go to definition":{bindKey:{win:"Ctrl-E",mac:"Ctrl-E"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,r,i,o,s,a,l;if(n=function(t){return e.editorInstance.executeCommand("load",t)},o=e.onlySelectedExpression(),o&&Et(t=o)){if(null!=t.id){for(i=ot(t)(e.ast),l=[],s=0,a=i.length;a>s;s++)if(r=i[s],jt(r)){r.imported?(e.selectInitially({name:r.imported.name}),n(r.imported.module)):e.mutate({inSelection:r});break}return l}if("module"===t.label)return e.editorInstance.executeCommand("load",t.symbol)}}}(this)},"insert call-site type":{bindKey:{win:"Ctrl-T",mac:"Ctrl-T"},indirect:!0,autocomplete:!0,exec:function(e){return function(t,n){var r,i,o,s,a;return i=(null!=n?n:{}).targetEditor,i&&(o=i.session.getMode(),r=o.onlySelectedExpression(),r&&r.tea)?(s=$.plainPrettyPrint(r.tea),a=s.replace(/_\d+/,""),e.startGroupMutation(),e.insertStringForward("(: "+a+")"),e.mutate({tangibleSelection:gt(c,dr(ur(e.onlySelectedExpression())))}),e.finishGroupMutation()):void 0}}(this)},"show type of an expression":{bindKey:{win:"Ctrl-Shift-T",mac:"Ctrl-Shift-T"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n;if(n=e.selectedTangible(),t=dn(n)||tt(n)){if(t.malformed)return window.log(t.malformed);if(t.tea)return window.log($.prettyPrint(t.tea))}}}(this)},"remove all source":{bindKey:{win:"Ctrl-Shift-Backspace",mac:"Ctrl-Shift-Backspace"},document:!1,exec:function(e){return function(){return e.editor.setValue(""),e.initAst("")}}(this)},"replace enclosing Parent expression with current selection":{bindKey:{win:"Ctrl-P",mac:"Ctrl-P"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,r,i;return i=e.realParentOfSelected(),i?(t=e.selectedTangible(),r=Mn(t,i.parent),n=wt([i]),e.mutate({changeInTree:{added:r,at:n},inSelections:mr(r)?r:void 0,tangibleSelection:hr(r)?gn(n.out):void 0})):void 0}}(this)},"wrap current selection in a Function":{bindKey:{win:"Ctrl-F",mac:"Ctrl-F"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t;return t=!Xt(e.selectedTangible())||e.isSingleLineInput?[" "]:["\n","  "],e.isInserting()?e.wrap.apply(e,["(","fn"," ",["[",{insert:!0},"]"]].concat(Fr.call(t),[{selected:!0}],[")"])):e.wrap("(","fn"," ","[]"," ",{selected:!0,select:!0},")")}}(this)},"Match on current selection":{bindKey:{win:"Ctrl-M",mac:"Ctrl-M"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.isInserting()?e.wrap("(","match"," ",{selected:!0,insert:!0},"\n","  "," ",")"):e.wrap("(","match"," ",{selected:!0},"\n","  ",{insert:!0}," ",")")}}(this)},"wrap in a Match to return current selection":{bindKey:{win:"Ctrl-Shift-M",mac:"Ctrl-Shift-M"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.wrap("(","match"," ",{insert:!0},"\n","  "," ",{selected:!0},")")}}(this)},"replace selection with an Added function parameter":{bindKey:{win:"Ctrl-Shift-A",mac:"Ctrl-A"},exec:function(e){return function(){var t,n,r,i;return i=$n(e.selectedTangiblesList())[0],i&&(n=dt(nr(i))),n&&(r=ht(n)),r?(t=gn(r.slice(-1)),e.mutate(et(mr(Cr(r))?{changeInTree:{added:E(" ",r),at:t}}:{},{newSelections:[t]}))):void 0}}(this)},"select all occurences of selection to Rename":{bindKey:{win:"Ctrl-R",mac:"Ctrl-R"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,r,i;return r=e.onlySelectedExpression(),r&&Et(t=r)?(n=ut(t)(e.ast),i=nn(rr,n),e.mutate({inSelection:t,newSelections:i})):void 0}}(this)},"Define selected token":{bindKey:{win:"Ctrl-D",mac:"Ctrl-D"},indirect:!0,exec:function(e){return function(t,n){var r,i,o,s,a,l,u,d,p,f,m,g,v,y,b,C,A;return b=(null!=n?n:{}).targetEditor,null==b&&(b=e.editor),C=b.session.getMode(),m=C.onlySelectedExpression(),m&&Et(i=m)&&i.malformed?(e.startGroupMutation(),b!==e.editor?e.insertStringForward(Kt(i)?(r=x(i.parent),""+i.symbol+" (fn ["+r.join(" ")+"]\n  )"):""+i.symbol+" "):(A=w(m),l=ln(h,rr(A)),y=bn(A)?"\n":"\n\n",e.insertSpaceAt(c,y,l),e.insertStringForward(Kt(i)?(r=x(i.parent),""+i.symbol+" (fn ["+r.join(" ")+"]\n  )"):""+i.symbol+" ")),s=o=e.selectableEdge(h),Kt(i)&&(s=Gn(h,nr(o))),e.mutate({tangibleSelection:s}),e.finishGroupMutation()):m?b!==e.editor?(a=Mn(rr(m),e.parentOfSelected()),e.startGroupMutation(),d=D(e.selectedTangible()),e.insertSpace(c," "),e.mutate({changeInTree:{added:a,at:e.selectedTangible()},tangibleSelection:d()}),e.finishGroupMutation()):(A=w(m),l=ln(h,rr(A)),a=Mn(e.selectedTangible(),A.parent),y=bn(A)?"\n":"\n\n",e.startGroupMutation(),v=e.selectedTangiblesList(),p=function(){var e,t,n;for(n=[],e=0,t=v.length;t>e;e++)g=v[e],this.mutate(this.removeSelectable(g)),n.push(D(this.selectedTangible()));return n}.call(e),e.insertSpaceAt(c,y,l),u=D(e.selectedTangible()),e.insertSpaceAt(c," ",l),f=wn(p),e.mutate({changeInTree:{added:a,at:{"in":[],out:[l]}},tangibleSelection:f[0],newSelections:Qt(f.slice(1),[u()])}),e.finishGroupMutation()):void 0}}(this)},"Inline selected expression or replace a name by its definition":{bindKey:{win:"Ctrl-I",mac:"Ctrl-I"},multiSelectAction:"forEach",exec:function(t){return function(){var n,r,i,o,s,a,l,u,h,d,p,f,m,g,v,y,b,C,w,A,x,E,_,S,T,F,D,k;if(A=t.onlySelectedExpression(),A&&Et(i=A)){if(!jt(i))return Pt(i)?t.worker.call("expand",[i.parent],function(e){var n;return e?(n=Dn([Q(e)],i.parent.parent),t.mutate({changeInTree:{added:n,at:rr(i.parent)},inSelections:n})):void 0}):t.lookupSource(i,function(e){var n;return n=Dn([e],i.parent),t.mutate({changeInTree:{added:n,at:t.selectedTangible()},inSelections:n})});if(m=ut(i)(t.ast),t.startGroupMutation(),(v=bn(i))&&(l=bn(v))&&Kt(l)&&Bt(l)&&ht(l)===v?(r=zn(nn(br,Ar(v)),l.parent),g=Cr(v).indexOf(i),g<r.length&&r[g]&&(d=rr(r[g]),t.mutate({changeInTree:{at:er(d)}}),t.mutate({changeInTree:{at:er(rr(i))}}))):(s=Pn(c,i))&&Rt(s)&&(d=rr(s),t.mutate(t.removeSelectable(qn(rr(i),d))),t.mutate(t.remove(e)),t.isInserting()&&t.mutate(t.remove(e))),d){for(u=_=0,F=m.length;F>_;u=++_)f=m[u],h=Mn(d,f.parent),t.mutate({changeInTree:{added:h,at:rr(f)}}),t.mutate(0===u?{inSelections:h}:{newSelections:[wt(h)]});return t.finishGroupMutation()}}else if(A&&St(b=A)||bn(A)&&St(b=bn(A))){for(a=gr(b),y=Ar(ht(a)),r=ur(b),t.startGroupMutation(),u=S=0,D=r.length;D>S;u=++S)if(n=r[u],u<y.length)for(E=ut(y[u])(b),T=0,k=E.length;k>T;T++)x=E[T],h=Mn(rr(n),x.parent),t.mutate({changeInTree:{added:h,at:rr(x)}});return r.length===y.length?(o=Cr(a)[2],C=Mn(rr(o),b.parent),t.mutate({changeInTree:{added:C,at:rr(b)},inSelections:C})):(p=Math.min(r.length,y.length),t.mutate({changeInTree:{at:Zn(qn(rr(y[0]),rr(y[p-1])))}}),t.mutate({changeInTree:{at:Zn(qn(rr(r[0]),rr(r[p-1])))}}),r.length<y.length&&(w=Mn(rr(a),b.parent),t.mutate({changeInTree:{added:w,at:rr(b)},inSelections:w}))),t.finishGroupMutation()}}}(this)},"abstract an operator with a Lambda":{bindKey:{win:"Ctrl-L",mac:"Ctrl-L"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,r,i,o;if(t=function(t,n){var r,i,o,s,a,l;return r=n.join(" "),a=E("(fn ["+r+"] ( "+r+"))",t[0].parent),e.startGroupMutation(),e.mutate({changeInTree:{added:a,at:wt(t)},inSelections:a}),l=Cr(a[0]),o=l[0],s=l[1],i=l[2],e.mutate({changeInTree:{added:Dn(t,i),at:gn([i[1]])}}),e.finishGroupMutation()
},Tt(i=e.parentOfSelected())){if(Kt(nr(o=e.selectedTangible())))return r=o["in"],n=x(i).slice(Ar(r).length-1),t(r,n);if((r=e.onlySelectedExpression())&&Et(r))return e.worker.call("docsFor",[F(r)],function(e){return e.arity?(n=e.arity,t([r],n)):void 0})}}}(this)},"push a lambda inside of a call to the Outer expression":{bindKey:{win:"Ctrl-O",mac:"Ctrl-O"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,r,i,o,s,a;return(n=e.onlySelectedExpression())&&Bt(n)&&Kt(n)&&(t=bn(n.parent))?(e.startGroupMutation(),a=Dn([st(n)],t),e.mutate({changeInTree:{added:a,at:rr(n.parent)}}),s=Dn([n.parent],t.parent),r=s[0],i=gr(r),e.mutate({changeInTree:{added:s,at:rr(t)}}),o=Dn([t],r),e.mutate({changeInTree:{added:o,at:rr(st(i))},inSelection:i}),e.finishGroupMutation()):void 0}}(this)},"push definition Up":{bindKey:{win:"Ctrl-U",mac:"Ctrl-U"},multiSelectAction:"forEach",exec:function(t){return function(){var n,r;return r=t.selectedTangible(),(n=function(i){var o,s,a,l,u,d,p,f,m,g,v,y,b;return v=w(i),s=jt(v)?Rt(o=Pn(c,v))?qn(rr(v),rr(o)):void 0:jt(u=Pn(e,v))?qn(rr(u),rr(v)):void 0,s&&bn(v)?(p=w(v.parent),l=ln(h,rr(p)),y=rn(r),m=y[0],f=y[1],b=Rn(s,p.parent,m),a=b[0],d=b[1],g=bn(p)?"\n":"\n\n",t.startGroupMutation(),t.mutate(t.removeSelectable(s)),t.isInserting()&&t.mutate(t.remove(e)),t.insertSpaceAt(c,g,l),t.mutate({changeInTree:{added:a,at:{"in":[],out:[l]}},memorableSelection:[f,d]}),t.finishGroupMutation()):n(bn(i))})(nr(t.selectedTangible()))}}(this)}})},m.prototype.multiSelectReferenceInDirection=function(e){var t,n,r;return r=this.onlySelectedExpression(),r&&Et(t=r)&&null!=t.id?(n=ot(t)(this.ast),this.mutate({newSelections:[rr(rt(e,t,n))]})):this.multiSelectOccurenceInDirection(e)},m.prototype.multiSelectOccurenceInDirection=function(e){var t,n;return this.isInserting()?void 0:(n=this.selectedTangible()["in"],t=it(n)(this.ast),this.mutate({newSelections:[wt(rt(e,n,t))]}))},m.prototype.selectReferenceInDirection=function(e){var t,n,r;return r=this.onlySelectedExpression(),r&&Et(t=r)&&null!=t.id?(n=ot(t)(this.ast),this.mutate({inSelection:rt(e,t,n)})):this.selectOccurenceInDirection(e)},m.prototype.selectOccurenceInDirection=function(e){var t,n;return this.isInserting()?void 0:(n=this.selectedTangible()["in"],t=it(n)(this.ast),this.mutate({inSelections:rt(e,n,t)}))},m.prototype.moveDown=function(e,t){var n;return this.mutate(this.isSelectingMultiple()?{tangibleSelection:this.selectableEdge(e)}:(n=this.onlySelectedExpression())?Lt(n)?{tangibleSelection:Gn(e,n)}:{withinAtom:n,withinAtomPos:X(t,n)}:{})},m.prototype.changeNumerical=function(e){var t,n,r,i,o;return(t=this.onlySelectedExpression())&&Ut(t)?(o=this.offsetToCursor(t),r=M(t.symbol,o,e),n=E(r,t.parent)[0],i=this.isEditing(),this.mutate({changeInTree:{added:[n],at:this.selectedTangible()},inSelection:i?void 0:n,withinAtom:i?n:void 0,withinAtomPos:i?n.symbol.length-(t.symbol.length-o):void 0})):void 0},m.prototype.closeParentOrInsert=function(e){return this.isEditingHalfDelimited()?this.insertStringForward(e):this.mutate({inSelection:this.realParentOfSelected()})},m.prototype.insertOpeningDelim=function(e,t){return this.isEditingHalfDelimited()?this.insertStringForward(e):this.wrap(e,{selected:!0,select:!0},t)},m.prototype.wrap=function(){var e,t,n,r,i;return i=1<=arguments.length?Fr.call(arguments,0):[],n=function(e){return"string"==typeof e},e=function(t){var r,i,o,s,a,l,c,u,h,d,p,f,m;for(h={},l=0,o=d=0,f=t.length;f>d;o=++d)if(u=t[o],!n(u))if(Array.isArray(u)){a=e(u);for(s in a)for(i=a[s],p=0,m=i.length;m>p;p++)r=i[p],c={},(null!=h[s]?h[s]:h[s]=[]).push({parent:o-l,child:r})}else{for(s in u)(null!=h[s]?h[s]:h[s]=[]).push(o-l);l++}return h},r=e(i),t=function(e){var r,i;return Array.isArray(e)?function(){var n,o,s;for(s=[],n=0,o=e.length;o>n;n++)i=e[n],(r=t(i))&&s.push(r);return s}().join(""):n(e)?e:void 0},this.wrapIn(t(i),this.selectedTangible(),r)},m.prototype.wrapIn=function(e,t,n){var r,i,o,s,a,l,c,u;if(a=n.selected,s=n.select,o=n.insert,null==a)throw new Error("missing selected in wrapIn");return u=E(e,Cn(t))[0],i=0===t["in"].length,r=function(e,t){return e.parent?r(e.child,t[e.parent]):t[e]},this.startGroupMutation(),this.mutate({changeInTree:{added:[u],at:t}}),c=Mn(t,u),l=Qt(s||[],o||[]),this.mutate({changeInTree:{added:c,at:{"in":[],out:[r(a[0],u)]}},inSelections:s&&!i?c:void 0,tangibleSelection:!s||i?{"in":[],out:[r(l[0],u)]}:void 0,newSelections:nn(function(e){return{"in":[],out:[r(e,u)]}},l.slice(1))}),this.finishGroupMutation()},m.prototype.removeNewLines=function(){var e,t,n,r;return r=this.selectedTangible(),t=r["in"],e=function(t){var n,r,i,o;for(o=[],r=0,i=t.length;i>r;r++)n=t[r],It(n)||o.push(Wt(n)?E(" ",n.parent)[0]:Lt(n)?en(e(n)):B(n));return o},n=e(t),this.mutate({changeInTree:{added:n,at:r},inSelections:n})},m.prototype.moveSelectionByLine=function(e){var t,n,r,i;return r=this.selectedTangible(),i=wt(this.allOnLine(nr(r))),(t=On(e,G(e,vn(e,i))))?(n=wt(this.allOnLine(t)),this.swap(e,i,n)):void 0},m.prototype.allOnLine=function(e){var t,n,r,i;return n=function(e){return function(t){var n;return n=e.rangeOfNodes([t]),n.start.row===n.end.row}}(this),t=function(e){return Rt(e)||Jt(e)},i=function(n){var r,i,o;for(r=e,o=[];(i=On(n,r))&&t(i);)o.push(r=i);return o},(r=bn(e))&&n(r)?this.allOnLine(r):P([i(l).reverse(),t(e)?[e]:[],i(h)])},m.prototype.moveSelection=function(e){var t,n,r;if(this.isEditing()){if(t=this.editedAtom(),!this.isAtLimit(e,t))return this.mutate({withinAtom:t,withinAtomPos:this.offsetToCursor(t)+e})}else if(r=this.selectedTangible(),n=this.selectedSibling(e))return this.swap(e,r,n)},m.prototype.swap=function(e,t,n){var r,i,o;return i=N(t["in"]),r=N(n["in"]),this.startGroupMutation(),this.mutate({changeInTree:{added:[],at:t}}),this.mutate({changeInTree:{added:r,at:{"in":[],out:t.out}}}),this.mutate({changeInTree:{added:[],at:n}}),o={"in":[],out:n.out},this.mutate({changeInTree:{added:i,at:o},inSelections:mr(i)?i:void 0,tangibleSelection:hr(i)?o:void 0}),this.finishGroupMutation()},m.prototype.insertStringForward=function(e){return this.insertString(c,e)},m.prototype.insertString=function(e,t){var n,r,i,o,s;if(null==t)throw"Missing string in insertString";return this.mutate(this.isEditing()?(r=this.editedAtom(),s=kt(r)?(i=S(r),Z(i,t)):t,o=this.offsetToCursor(r),{changeWithinAtom:{string:s,range:"char"===r.label&&"\\_"===r.symbol?[1,2]:[o,o]}}):(n=E(t,this.parentOfSelected()),et({changeInTree:{added:n,at:this.selectedTangible()}},1===n.length&&Et(r=n[0])?{withinAtom:r,withinAtomPos:r.symbol.length}:{inSelections:n})))},m.prototype.insertSpace=function(e,t){return this.isEditing()&&kt(this.editedAtom())?this.insertString(e,t):this.insertSpaceAt(e,t,this.selectedNodeEdge(e))},m.prototype.replaceSpace=function(e,t){var n,r,i;return i=this.toSelectionSibling(e),n=i.margin,r=i.siblingTangible,n&&Jt(G(fn(e),n["in"]))?this.mutate({changeInTree:{added:E(t,Cn(n)),at:n},tangibleSelection:r}):this.insertSpace(e,t)},m.prototype.insertSpaceAt=function(e,t,n){var r,i;return i=n.parent,r=E(t,i),this.mutate({changeInTree:{added:r,at:{"in":[],out:[n]}},tangibleSelection:{"in":[],out:e===c?[n]:r}})},m.prototype.selectLineAdjecentAtomOrPosition=function(e){var t,n,r,i,o,s,a,c,u,h,d;return a=this.startPos(u=nr(this.selectedTangible())),n=null!=(d=this.editor.selection.$desiredColumn)?d:a.column,c=a.row+e,t=this.tangibleAtPos({row:c,column:n+1}),h=Lt(r=nr(t))?(o=this.startPos(r),i=this.edgeOfNode(e,r),s=i.row===c&&o.column>n?l:zt(u,r)?e:fn(e),tr(Zt(s,nr(t)))):t,this.mutate({tangibleSelection:h,desiredColumn:n})},m.prototype.selectFollowingAtomOrPosition=function(e){return this.isSelectingMultiple()?this.selectSibling(e):this.mutate({tangibleSelection:yt(e,this.selectedTangible())})},m.prototype.selectSibling=function(e){var t;return this.mutate(this.isSelectingMultiple()?{tangibleSelection:this.selectableEdge(e)}:(t=this.selectedSibling(e),!t&&Gt(this.parentOfSelected())?{inSelection:this.parentOfSelected()}:{tangibleSelection:t}))},m.prototype.expandSelection=function(e){var t,n,r,i;return i=this.toSelectionSibling(e),t=i.margin,n=i.siblingTangible,this.mutate(n?(r=A(e,t,n),{tangibleSelection:A(e,this.selectedTangible(),r)}):{inSelection:this.realParentOfSelected()})},m.prototype.tangibleAtPos=function(e){var t,n,r,i;return i=this.tokensSurroundingPos(e),n=i[0],t=i[1],r=Yn(c,n,t||n)},m.prototype.tokenFollowingPos=function(e){var t,n,r;return r=this.tokensSurroundingPos(e),n=r[0],t=r[1],t||n},m.prototype.tokensSurroundingPos=function(e){var t;return t=this.trimmedPosToIdx(e),ct(this.ast,t-1,t+1)},m.prototype.tangibleRange=function(e){var t,n,r;return r=cn(e),n=r[0],t=r[1],An(this.startPos(n),this.startPos(t))},m.prototype.remove=function(e){var t,n,r,i,o,s,a,u,d,f;return this.mutate((n=this.editedAtom())?t=Y(n)===(kt(n)?0:1)?this.removeSelectable(this.selectedTangible()):(o=this.offsetToCursor(n),u=this.isAtLimit(e,n)?fn(e):e,{changeWithinAtom:{string:"",range:[o,o+u]}}):this.isSelecting()?this.removeSelectable(this.selectedTangible()):(f=this.selectedTangible(),r=this.selectionMargin(e),u=r?e:fn(e),d=this.selectionMargin(u),d?(a=On(p,ln(l,d)),i=ln(h,d),{changeInTree:{at:d},tangibleSelection:Yn(c,a,i)}):Gt(s=this.parentOfSelected())?this.removeSelectable(wt([s])):{}))},m.prototype.removeSelected=function(){return this.isInserting()?void 0:this.mutate(this.removeSelectable(this.selectedTangible()))},m.prototype.removeSelectable=function(e){return{changeInTree:{at:e},tangibleSelection:{"in":[],out:e.out}}},m.prototype.isAtLimit=function(e,t){var n;return n=this.distance(this.cursorPosition(),this.editableEdge(e,t)),0===n},m.prototype.offsetToCursor=function(e){return this.distance(this.cursorPosition(),this.startPos(e))},m.prototype.selectedText=function(){return this.isEditing()?this.editedAtom().symbol:this.editor.getSelectedText()},m.prototype.selectableEdge=function(e){return Kn(e,this.selectedTangible())},m.prototype.editableEdge=function(e,t){return kt(t)?this.idxToPos(V(e,t)+fn(e)):this.edgeOfNode(e,t)},m.prototype.realParentOfSelected=function(){var e;return Gt(e=this.parentOfSelected())?e:void 0},m.prototype.parentOfSelected=function(){return Cn(this.selectedTangible())},m.prototype.selectedSibling=function(e){return this.toSelectionSibling(e).siblingTangible},m.prototype.toSelectionSibling=function(e){var t,n;return t=this.selectionMargin(e),t?(n=vn(e,t),{margin:t,siblingTangible:Yn(e,G(e,t["in"]),G(fn(e),n))}):{}},m.prototype.selectionMargin=function(e){return Jn(e,this.selectedTangible())},m.prototype.selectedNodeEdge=function(e){return ln(e,this.selectedTangible())},m.prototype.editedAtom=function(){return this.isEditing()?this.onlySelectedExpression():void 0},m.prototype.onlySelectedExpression=function(){return dn(this.selectedTangible())},m.prototype.startGroupMutation=function(){return this.groupMutating=!0},m.prototype.finishGroupMutation=function(){return this.groupMutating=!1,this.undoManager().packGroupMutation()},m.prototype.registerMutation=function(e,t){var n,r,i;return r=this.isEditing()?(n=this.editedAtom(),{withinAtom:n,withinAtomPos:this.distance(this.startPos(n),this.editor.selection.getRange().end)}):{tangibleSelection:this.selectedTangible()},"function"==typeof(i=this.undoManager()).registerMutation?i.registerMutation(e,r,t):void 0},m.prototype.replay=function(e,t){var n,r,i,o;if(r=e.pop()){for(this.startGroupMutation(),i=0,o=r.length;o>i;i++)n=r[i],this.mutate(n,t);return this.finishGroupMutation()}},m.prototype.mutate=function(e,t){var n,r,i,o,s,a,l,c,u,h,d,p,f,m,g,v,y;if(null==t&&(t={undo:!0}),this.registerMutation(e,t),this.groupMutating||"function"==typeof(f=this.undoManager()).packGroupMutation&&f.packGroupMutation(),e.changeInTree&&(c=e.changeInTree.at,n=e.changeInTree.added||[],l=this.rangeOfTangible(c),r=hn(n),b(c,n)),e.changeWithinAtom){if(l)throw"atom edit during tree edit not supported";c=e.changeWithinAtom.range,n=e.changeWithinAtom.string,i=e.changeWithinAtom.atom||this.editedAtom(),l=this.rangeWithingAtom(i,c),r=n,C(i,c,n)}if(null!=r&&(this.repositionAst(),this.docReplace(l,r)),(e.inSelection||e.inSelections||e.tangibleSelection||e.selectionRange||e.memorableSelection)&&(d=e.tangibleSelection||e.selectionRange&&this.tangibleSelectionFromRange(e.selectionRange)||e.memorableSelection&&(v=e.memorableSelection,a=v[0],u=v[1],v)&&a(u)||wt(e.inSelections||[e.inSelection]),h=this.rangeOfTangible(d),o=!1),e.withinAtom){if(d)throw"shouldn't set both withinAtom and selection";d=wt([e.withinAtom]),h=this.rangeWithingAtom(e.withinAtom,[e.withinAtomPos,e.withinAtomPos]),o=!0}if(d&&(this.select(d,o),this.setSelectionRange(h,e.desiredColumn)),e.newSelections)for(y=e.newSelections,m=0,g=y.length;g>m;m++)p=y[m],s=this.tangibleRange(p),this.selectFor(p,!1,s),this.editor.selection.addRange(s);return!0},m.prototype.handleCommandExecution=function(e){return this.updateEditingMarkers(),this.updateErrorMarkers(),this.closeTooltip(),this.doAutocomplete(e)},m.prototype.select=function(e,t){return this.editor.selection.$nodes=e,this.editor.selection.$editing=t},m.prototype.selectFor=function(e,t,n){return n.$nodes=e,n.$editing=t},m.prototype.setSelectionRange=function(e,t){return this.editor.selection.setSelectionRange(e),this.editor.selection.$desiredColumn=t},m.prototype.updateEditingMarkers=function(){var e,t,n,r,i;for(e=this.isMultiSelecting()?this.editor.multiSelect.ranges:[this.editor.selection],t=r=0,i=e.length;i>r;t=++r)n=e[t],this.updateEditingMarkerFor(this.isEditingFor(n),n)},m.prototype.updateEditingMarkerFor=function(e,t){var n,r,i;return(r=t.$editMarker)&&(this.editor.session.removeMarker(r),t.$editMarker=void 0),e?(n=dn(t.$nodes),i=this.editableRange(n),r=this.editor.session.addMarker(i,"ace_active-token"),t.$editMarker=r):void 0},m.prototype.isMultiSelecting=function(){return this.editor.multiSelect.inMultiSelectMode},m.prototype.selectedTangiblesList=function(){var e,t,n,r;if(this.isMultiSelecting()){for(n=this.editor.multiSelect.ranges,r=[],t=n.length-1;t>=0;t+=-1)e=n[t],r.push(e.$nodes);return r}return[this.selectedTangible()]},m.prototype.selectedTangible=function(){return this.editor.selection.$nodes},m.prototype.isEditing=function(){return this.editor.selection.$editing},m.prototype.isEditingFor=function(e){return e.$editing},m.prototype.isEditingDelimited=function(){return this.isEditing()&&kt(this.editedAtom())},m.prototype.isEditingHalfDelimited=function(){return this.isEditing()&&Nt(this.editedAtom())},m.prototype.isSelecting=function(){return!this.isEditing()&&this.selectedTangible()["in"].length>0},m.prototype.isSelectingMultiple=function(){return this.isSelecting()&&this.selectedTangible()["in"].length>1},m.prototype.isInserting=function(){return 0===this.selectedTangible()["in"].length},m.prototype.toText=function(e){return this.editor.session.doc.getTextRange(this.range(e))},m.prototype.editableRange=function(e){return kt(e)?this.delimitedAtomRange(e):this.range(e)},m.prototype.cursorPosition=function(){return this.editor.getCursorPosition()},m.prototype.handleRangeDeselect=function(e){var t,n,r,i,o;for(n=e.ranges,o=[],r=0,i=n.length;i>r;r++)t=n[r],o.push(this.updateEditingMarkerFor(!1,t));return o},m.prototype.delimitedAtomRange=function(e){var t,n,r;return r=this.range(e),n=r.start,t=r.end,f.fromPoints(this.shiftPosBy(n,1),this.shiftPosBy(t,-1))},m.prototype.rangeWithingAtom=function(e,t){var n,r,i;return i=Wn(t),r=i[0],n=i[1],f.fromPoints(this.idxToPos(e.start+r),this.idxToPos(e.start+n))},m.prototype.rangeOfNodes=function(e){var t,n;return t=e[0],n=e[e.length-1],An(this.startPos(t),this.endPos(n))},m.prototype.rangeOfTangible=function(e){var t,n,r;return r=cn(e),t=r[0],n=r[1],An(this.startPos(t),this.startPos(n))},m.prototype.range=function(e){var t,n;return n=this.startPos(e),t=this.endPos(e),f.fromPoints(n,t)},m.prototype.endOfLine=function(e){return this.idxToPos(this.posToIdx({row:e.row+1,column:0})-1)},m.prototype.edgeOfNode=function(e,t){return this.idxToPos(V(e,t))},m.prototype.nodeRange=function(e){return An(this.startPos(e),this.endPos(e))},m.prototype.startPos=function(e){return this.idxToPos(e.start)},m.prototype.endPos=function(e){return this.idxToPos(e.end)},m.prototype.distance=function(e,t){return Math.abs(this.posToIdx(t)-this.posToIdx(e))},m.prototype.idxToPos=function(e){return this.editor.session.doc.indexToPosition(e)},m.prototype.posToIdx=function(e){return this.editor.session.doc.positionToIndex(e)},m.prototype.trimmedPosToIdx=function(e){return this.posToIdx(this.editor.session.$clipPositionToDocument(e.row,e.column))},m.prototype.shiftPosBy=function(e,t){return this.idxToPos(this.posToIdx(e)+t)},m.prototype.docReplace=function(e,t){var n;return n=this.editor.session.doc,n.remove(e),n.insert(e.start,t)},m.prototype.prepareWorker=function(){var e;return e=new s(["ace","compilers"],"compilers/teascript/worker","Worker",null),this.worker=e},m.prototype.createWorker=function(e){if(!this.worker)throw new Error("Missing worker in mode");return this.worker.attachToDocument(e.getDocument()),this.worker.on("error",function(t){return e.setAnnotations([t.data])}),this.worker.on("ok",function(){return function(){return e.clearAnnotations()}}(this)),this.worker},m.prototype.reportModuleName=function(e){return e!==this.moduleName?(this.moduleName=e,this.worker.call("setModuleName",[e])):void 0},m}(g),o=function(){function e(e){this.mode=e,this.reset=Er(this.reset,this),this.redo=Er(this.redo,this),this.undo=Er(this.undo,this),this.packGroupMutation=Er(this.packGroupMutation,this),this.registerMutation=Er(this.registerMutation,this),this.execute=Er(this.execute,this),this.reset()}return e.prototype.execute=function(){},e.prototype.registerMutation=function(e,t,n){var r,i,o,s,a,l,c,u;return l=n.undo?this.undoStack:this.redoStack,a=[],e.changeInTree&&(s=e.changeInTree.at,r=e.changeInTree.added||[],a.push({changeInTree:{at:{"in":r,out:s.out},added:s["in"]}})),e.changeWithinAtom&&(u=Wn(e.changeWithinAtom.range),o=u[0],c=u[1],r=e.changeWithinAtom.string,i=e.changeWithinAtom.atom||this.mode.editedAtom(),a.push({changeWithinAtom:{range:[o,o+r.length],string:i.symbol.slice(o,c),atom:i}})),a.push(t),this.groupMutationRegister.stack=l,this.groupMutationRegister.states.push(on(a))},e.prototype.packGroupMutation=function(){var e,t,n,r;return r=this.groupMutationRegister,t=r.stack,n=r.states,n.reverse(),t.push(this.sameKindMutation(n,t[t.length-1]||[])?e=n.concat(t.pop()):n),this.groupMutationRegister={states:[]}},e.prototype.undo=function(){return this.mode.replay(this.undoStack,{redo:!0})},e.prototype.redo=function(){return this.mode.replay(this.redoStack,{undo:!0})},e.prototype.reset=function(){return this.undoStack=[],this.redoStack=[],this.groupMutationRegister={states:[]}},e.prototype.sameKindMutation=function(e,t){var n,r,i,o,s,a,l,c,u,h,d;return e.length>0&&t.length>0?(i=e[0],r=t[0],(n=null!=(o=i.changeInTree)?o.added[0]:void 0)&&n===(null!=(s=r.changeWithinAtom)?s.atom:void 0)||(n=null!=(a=i.changeWithinAtom)?a.atom:void 0)&&i.changeWithinAtom.string.length>0&&n===(null!=(l=r.changeWithinAtom)?l.atom:void 0)&&r.changeWithinAtom.string.length>0||(n=null!=(c=i.changeWithinAtom)?c.atom:void 0)&&0===i.changeWithinAtom.string.length&&n===(null!=(u=r.changeInTree)?u.at["in"][0]:void 0)||(n=null!=(h=i.changeWithinAtom)?h.atom:void 0)&&0===i.changeWithinAtom.string.length&&n===(null!=(d=r.changeWithinAtom)?d.atom:void 0)&&0===r.changeWithinAtom.string.length):!1},e}(),x=function(e){var t,n,r,i,o,s,a,l,c,u;for(i="xyzwtuvmnopqrs",s=!1,o=0,n={},r=[],t=function(e){var t;return r.push((t=n[e])?(n[e]++,e+t):(n[e]=2,e))},u=ur(e),l=0,c=u.length;c>l;l++)a=u[l],s?s=!1:t($t(a)?(s=!0,fr(a)):!Et(a)||Nt(a)||Ut(a)?i[o++]:a.symbol);return r},Xt=function(e){var t;return Gt(t=Cn(e))?Vt(t):!0},w=function(e){var t;return(t=bn(e))?Vt(t)&&Rt(e)?e:w(t):e},pt=function(e,t){return dt(t)||e},dt=function(e){return Bt(e)?e:Gt(e.parent)?dt(e.parent):void 0},ht=function(e){var t;return t=ur(e)[0]},st=function(e){var t,n;return n=ur(e),t=n[n.length-1]},St=function(e){return Tt(e)&&Bt(gr(e))},Vt=function(e){var t;return Bt(e)||Lt(e)&&"syntax"===(null!=(t=gr(e))?t.symbol:void 0)},Bt=function(e){var t;return Lt(e)&&"fn"===(null!=(t=gr(e))?t.symbol:void 0)},Ot=function(e){var t,n;return!(Lt(e)&&("#"===(t=null!=(n=gr(e))?n.symbol:void 0)||":"===t))},Q=function(e){var t,n,r,i,o,s,a,l,c;if(Lt(t=e)){for(o=t.slice(0,2),c=t.slice(2,-1),n=a=0,l=c.length;l>a;n=++a)s=c[n],Yt(s)||(r=t[n-1+2],i=It(r)?t.slice(n-2+2,n+2):Yt(r)?[r]:[ir(" ")],o.push.apply(o,Fr.call(i).concat([Q(s)])));return o.push(t[t.length-1]),en(o)}return e},U=function(e){var t;return(t=bn(e))?jt(Pn(p,t))?t:U(t):void 0},jt=function(e){return"name"===(null!=e?e.label:void 0)},Pt=function(e){return"keyword"===(null!=e?e.label:void 0)},it=function(e){return function(t){var n,r,i,o,s;return o=e.length,r=function(){var n,r,a;if(1===o){if(un(e[0],t))return[[t]]}else if(Lt(t)&&t.length>=o){for(a=[],i=n=0,r=t.length-o;r>=0?r>=n:n>=r;i=r>=0?++n:--n)un(s=t.slice(i,i+o),e)&&a.push(s);return a}}(),n=Lt(t)?j(it(e),t):void 0,Qt(r||[],n||[])}},un=function(e,t){return Lt(e)?Lt(t)&&e.length===t.length&&y(lr(un,e,t)):e.symbol===t.symbol},at=function(e,t){var n,r,i;for(r=0,i=t.length;i>r;r++)if(n=t[r],jt(n)&&n.symbol===e)return n},F=function(e){return{name:e.symbol,scope:e.scope}},ot=function(e){return function(t){return Lt(t)?j(ot(e),t):t.id===e.id?[t]:[]}},ut=function(e){return function(t){return Lt(t)?j(ut(e),t):t.id===e.id&&t!==e?[t]:[]}},Pn=function(e,t){var n,r,i,o,s;for(i=Cr(t.parent),n=o=0,s=i.length;s>o;n=++o)if(r=i[n],r===t)return e===c?i[n+1]:i[n-1]},rt=function(e,t,n){var r,i,o,s;for(e>0?(o=0,s=n.length):o=n.length-1;e>0?s>o:o>=0;o+=e){if(r=n[o],i)return r;(r===t||r[0]&&r[0]===t[0])&&(i=!0)}return G(fn(e),n)},dn=function(e){var t;return t=e["in"][0],1===e["in"].length&&Rt(t)?t:void 0},tt=function(e){var t;return t=e.out[0],t.fake?t:void 0},$n=function(e){var t,n,r,i;return t=nn(cr(q,Cn),e),n=Math.min.apply(Math,t),r=function(){var t,r,o;for(o=[],t=0,r=e.length;r>t;t++)i=e[t],o.push(Un(i,q(Cn(i))-n));return o}(),Nn(r)},Nn=function(e){var t,n,r,i;for(t=Cn(e[0]),r=0,i=e.length;i>r;r++)if(n=e[r],Cn(n)!==t)return Nn(nn(Xn,e));return e},Un=function(e,t){return 0===t?e:Un(Xn(e),t-1)},qn=function(e,t){var n,r,i,o,s;return s=jn(e,t),n=s[0],o=s[1],i=Cn(n),r=ln(l,n),{"in":i.slice(R(r),L(o)),out:o.out}},er=function(e){var t;return W(nt(pr,[t=Jn(p,e),e,t?void 0:Jn(d,e)]))},Zn=function(e){return W(nt(pr,[Jn(p,e),e,Jn(d,e)]))},Jn=function(e,t){var n,r;return r=vn(e,t),n=G(e,r),Yt(n)?wt(r):null},jn=function(e,t){return L(e)>L(t)?[t,e]:[e,t]},Kn=function(e,t){var n;return n=G(e,t["in"]),e===c||0===t["in"].length?{"in":!n||Yt(n)?[]:[n],out:t.out}:Yt(n)?{"in":[],out:[n]}:wt([n])},Cn=function(e){return e.out[0].parent},L=function(e){return R(e.out[0])},ln=function(e,t){return G(e,cn(t))},cn=function(e){var t,n;return t=Qt(e["in"],e.out)[0],n=e.out[0],[t,n]},wt=function(e){var t,n;return t=e[e.length-1],n=On(d,t),{"in":e,out:ar(n)}},gn=function(e){return{"in":[],out:ar(e[0])}},W=function(e){var t,n,r;return t=2<=e.length?Fr.call(e,0,r=e.length-1):(r=0,[]),n=e[r++],{"in":Qt(j(Qn,t),n["in"]),out:n.out}},Qn=function(e){return e["in"]},gt=function(e,t){var n;return n=function(e){return Et(e)&&!Ht(e)},mt(n,e,t)},ft=function(e,t){return mt(Rt,e,t)},mt=function(e,t,n){var r,i,o;for(i=Gn(fn(t),n);(o=e(r=nr(i)))&&zt(r,n);)i=yt(t,i);return o?n:i},zt=function(e,t){return e&&(e===t||zt(e.parent,t))},yt=function(e,t){return T(e,In(e,ln(e,t)))},T=function(e,t){var n;return t?(n=_t(t))?n:T(e,In(e,t)):void 0},_t=function(e){var t;return t=xn(e),(Yt(e)&&!It(e)||Ft(e))&&!Ft(t)?{"in":Rt(t)?[t]:[],out:ar(e)}:void 0},Xn=function(e){var t;return t=Cn(e),Gt(t)?wt([t]):void 0},Yn=function(e,t,n){var r,i,o;return o=bt(e,t,n),i=o[0],r=o[1],i===r&&Rt(i)?wt([i]):Ft(i)?wt([i.parent]):qt(r)?wt([r.parent]):Rt(i)?{"in":[i],out:ar(r)}:Rt(r)?wt([r]):qt(i)||!It(r)?{"in":[],out:ar(r)}:Vn(e,n)},Vn=function(e,t){var n;return(n=On(e,t))&&Yn(e,t,n)},Gn=function(e,t){return Kn(e,xt(t))},bt=function(e,t,n){return e===c?[t,n]:[n,t]},xt=function(e){return{"in":e.slice(1,-1),out:e.slice(-1)}},yn=function(e,t){return G(e,vn(e,t))},vn=function(e,t){return e===c?t.out:En(On(p,nr(t)))},wn=function(e){return nn(function(e){return e()},e)},D=function(e){var t;return t=xn(nr(e)),function(){return{"in":[],out:ar(vt(t))}}},rn=function(e){return 0===e["in"].length?[[e.out[0]],gn]:[e["in"],wt]},tr=function(e){return Rt(e)?rr(e):{"in":[],out:ar(e)}},rr=function(e){return wt([e])},nr=function(e){return ln(l,e)},En=function(e){return It(e)?[On(p,e),e]:[e]},ar=function(e){var t;return t=On(d,e),Yt(e)&&t&&It(t)?[e,t]:[e]},Zt=function(e,t){return Lt(t)?Zt(e,G(e,Cr(t))):t},q=function(e){return Gt(e)?1+q(e.parent):-1},At=function(e,t,n){return e.parent=t,t.splice(n,0,e)},b=function(e,t){var n,r,i,o,s;for(i=e.out[0].parent,o=0,s=t.length;s>o;o++)r=t[o],r.parent=i;return n=R(ln(l,e)),i.splice.apply(i,[n,e["in"].length].concat(Fr.call(t)))},C=function(e,t,n){var r,i,o,s;return s=Wn(t),o=s[0],r=s[1],i=r-o,e.symbol=Hn(e.symbol,o,i,n),e.end+=n.length-i},A=function(e,t,n){var r,i,o;return o=bt(e,t,n),i=o[0],r=o[1],{"in":Qt(i["in"],r["in"]),out:r.out}},Wn=function(e){var t,n;return t=e[0],n=e[1],[Math.min(t,n),Math.max(t,n)]},hn=function(e){var t,n,r,i;for(n="",r=0,i=e.length;i>r;r++)t=e[r],n+=Lt(t)?hn(t):t.symbol;return n},Y=function(e){return e.symbol.length-(kt(e)?2:Nt(e)?1:0)},M=function(e,t,n){var r,i,o,s,a;return s=e.length,o=(r=e.indexOf("."))>=0?r+1:s,i=s-o,a=parseFloat(e),a*=Math.pow(10,i),n*=Math.pow(10,s-t-(o!==s&&o>t?1:0)),a+=n,a/=Math.pow(10,i),a.toFixed(i)},Rt=function(e){return!Yt(e)&&!Dt(e)},Et=function(e){return Rt(e)&&!Lt(e)},Ut=function(e){return e.symbol&&/^-?\d/.test(e.symbol)},kt=function(e){var t;return"string"===(t=e.label)||"regex"===t},Nt=function(e){return"char"===e.label||kt(e)},S=function(e){return e.symbol[0]},Dt=function(e){return/^[\(\)\[\]\{\}]$/.test(e.symbol)},Ft=function(e){return/^[\)\]\}]$/.test(e.symbol)},qt=function(e){return/^[\(\[\{]$/.test(e.symbol)},Kt=function(e){var t;return t=bn(e),t&&Tt(t)&&dr(Cr(t))===e},Mt=function(e){return 2===e.length&&"("===e[0].symbol},$t=function(e){return"label"===e.label},Yt=function(e){var t;return"whitespace"===(t=e.label)||"indent"===t},It=function(e){return"indent"===e.label},Jt=function(e){return" "===e.symbol},Wt=function(e){return"\n"===e.symbol},Gt=function(e){return e.start>=0},Z=function(e,t){return t.replace(RegExp(""+e,"g"),"\\"+e)},Ln=function(e,t){return new Array(e+1).join(t)},on=function(e){var t,n,r,i,o,s;for(n={},o=0,s=e.length;s>o;o++){t=e[o];for(r in t)i=t[r],n[r]=i}return n},et=function(e,t){return on([e,t])},wr=function(e){return e.transformed?wr(e.transformed):e},lt=function(e,t,n){var r;return t<e.end&&e.start<n?t===e.start&&n===e.end?[e]:P(function(){var i,o,s;for(s=[],i=0,o=e.length;o>i;i++)r=e[i],s.push(lt(r,t,n));return s}()):[]},ct=function(e,t,n){var r;return t<e.end&&e.start<n?Lt(e)?P(function(){var i,o,s;for(s=[],i=0,o=e.length;o>i;i++)r=e[i],s.push(ct(r,t,n));return s}()):[e]:[]},z=function(e){var t,n;return t=nn(H,e),(n=t[t.length-1])&&"\n"===n.value&&t.pop(),t},H=function(e){var t;return t=Dt(e),{value:"string"===e.label?""+e.symbol.slice(1,-1)+"":e.symbol,type:function(){if(t&&e.parent.malformed||!t&&e.malformed)return"token_malformed";switch(e.label){case"whitespace":return"text";default:return e.label?"token_"+e.label:"text"}}()+(e.fake?".token_fake":"")}},or=function(e){var t;return t=e.slice(1,-1),t.start=e.start+1,t.end=e.end-1,t},V=function(e,t){return e===c?t.end:t.start},X=function(e,t){return J(e,t)+(kt(t)?fn(e):0)},J=function(e,t){return e===c?t.symbol.length:0},G=function(e,t){var n,r;return n=t[0],r=t[t.length-1],e===c?r:n},An=function(e,t){return f.fromPoints(e,t)},Hn=function(e,t,n,r){return e.slice(0,t)+r+e.slice(t+n)},Sn=function(e){var t,n,r,i;for(n=!1,i=e.parent,r=i.length-1;r>=0;r+=-1){if(t=i[r],n&&Rt(t))return t;t===e&&(n=!0)}return e},an=function(e){var t,n,r,i,o;for(n=!1,o=e.parent,r=0,i=o.length;i>r;r++){if(t=o[r],n&&Rt(t))return t;t===e&&(n=!0)}return e},xn=function(t){return In(e,t)},vt=function(e){return In(c,e)},In=function(e,t){var n;return n=On(e,t)||Gt(t.parent)&&In(e,t.parent),n?Lt(n)?G(fn(e),n):n:void 0},bn=function(e){return Gt(e.parent)?e.parent:void 0},On=function(e,t){return t.parent[R(t)+e]},_n=function(e){return e.parent[R(e)-1]},sn=function(e){return e.parent[R(e)+1]},R=function(e){return Ct(e,e.parent)},Ct=function(e,t){var n,r,i,o;for(r=i=0,o=t.length;o>i;r=++i)if(n=t[r],n===e)return r;throw new Error("what is not inside of array in indexWithin")},K=function(e,t){var n,r,i,o,s;if(t.malformed=e.malformed,t.tea=e.tea,t.id=e.id,t.fake=e.fake,t.assignable=e.assignable,t.scope=e.scope,t.inferredType=e.inferredType,t.imported=e.imported,Lt(e)){for(s=[],n=i=0,o=e.length;o>i;n=++i)r=e[n],s.push(K(r,t[n]));return s}return t.label=e.label},Rn=function(e,t,n){return kn(e["in"],t,n)},Mn=function(e,t){return Dn(e["in"],t)},Dn=function(e,t){var n;return n=kn(e,t,[])[0]},kn=function(e,t,n){var r,i,o,s,a,l;for(l=I(e,n),r=l[0],o=l[1],s=0,a=r.length;a>s;s++)i=r[s],i.parent=t;return[Fn(r,t),o]},E=function(e,t){var n,r,i,o,s;return o=$.astizeList(e),Tn(q(t),o),i=o[0],r=3<=o.length?Fr.call(o,1,s=o.length-1):(s=1,[]),n=o[s++],r},N=function(e){var t;return t=I(e,[])[0]},I=function(e,t){var n,r,i;return i=sr(nn(O(t),e)),n=i[0],r=i[1],[n,P(r)]},B=function(e){var t;return t=O([])(e)[0]},O=function(e){return function(t){var n,r,i;return Lt(t)?(i=I(t,e),n=i[0],r=i[1],en(n)):(r=[],n={symbol:t.symbol,label:t.label}),n.start=t.start,n.end=t.end,n.malformed=t.malformed,n.tea=t.tea,n.id=t.id,Tr.call(e,t)>=0&&(r=[n]),[n,r]}},Fn=function(e,t){return Tn(q(t),e),e},Tn=function(e,t,n,r){var i,o,s,a,l,c;if(Lt(t))for(i=0;i<t.length;)Tn(e+1,t[i],t[i+1],i+1),++i;else n&&Wt(t)&&(o=Ln(e,"  "),l=e>0,It(n)?l?Bn(n,o):n.parent.splice(r,1):l&&(c=_("\n  "),a=c[0],s=c[1],Bn(s,o),At(s,n.parent,R(n))))},en=function(e){var t,n,r;for(n=0,r=e.length;r>n;n++)t=e[n],t.parent=e;return e},Bn=function(e,t){return e.symbol=t,e.end=e.start+t.length},_=function(e){var t,n,r,i,o;return o=$.astizeExpression("("+e+")"),r=o[0],n=3<=o.length?Fr.call(o,1,i=o.length-1):(i=1,[]),t=o[i++],n},h=c=d=1,l=e=p=-1,fn=function(e){return-1*e}});