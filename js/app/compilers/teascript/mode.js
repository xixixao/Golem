define(function(require,exports,module){var e,t,n,i,r,o,s,a,c,l,u,h,d,p,f,g,m,v,y,b,w,C,E,A,x,S,_,F,D,T,k,R,M,L,B,$,O,N,P,I,j,W,H,U,K,z,q,V,G,Y,X,Q,J,Z,et,tt,nt,it,rt,ot,st,at,ct,lt,ut,ht,dt,pt,ft,gt,mt,vt,yt,bt,wt,Ct,Et,At,xt,St,_t,Ft,Dt,Tt,kt,Rt,Mt,Lt,Bt,$t,Ot,Nt,Pt,It,jt,Wt,Ht,Ut,Kt,zt,qt,Vt,Gt,Yt,Xt,Qt,Jt,Zt,en,tn,nn,rn,on,sn,an,cn,ln,un,hn,dn,pn,fn,gn,mn,vn,yn,bn,wn,Cn,En,An,xn,Sn,_n,Fn,Dn,Tn,kn,Rn,Mn,Ln,Bn,$n,On,Nn,Pn,In,jn,Wn,Hn,Un,Kn,zn,qn,Vn,Gn,Yn,Xn,Qn,Jn,Zn,ei,ti,ni,ii,ri,oi,si,ai,ci,li,ui,hi,di,pi,fi,gi,mi,vi,yi,bi,wi=module.uri||"",Ci=(wi.substring(0,wi.lastIndexOf("/")+1),function(e,t){return function(){return e.apply(t,arguments)}}),Ei={}.hasOwnProperty,Ai=function(e,t){function n(){this.constructor=e}for(var i in t)Ei.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},xi=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1},Si=[].slice;v=require("ace/ace"),f=require("ace/range").Range,m=require("ace/mode/text").Mode,t=require("ace/mode/behaviour").Behaviour,g=require("ace/selection").Selection,un=require("ace/lib/oop"),a=require("ace/lib/event_emitter").EventEmitter,u=require("ace/keyboard/hash_handler").HashHandler,i=require("./CustomAutocomplete"),r=require("./CustomSearchBox"),n=require("./CombinedTooltip"),s=require("app/DistributingWorkerClient"),Jt=function(e){return console.log(e),e},fi=P=require("./compiler"),Rt=fi.isForm,St=fi.isCall,I=fi.concat,Zt=fi.map,j=fi.concatMap,oi=fi.zipWith,ii=fi.unzip,nt=fi.filter,Yt=fi.join,y=fi.all,si=fi.__,In=fi.sortedArgs,dn=fi.originOf,ui=fi._is,di=fi._notEmpty,ci=fi._empty,pi=fi._operator,ai=fi._arguments,vi=fi._terms,bi=fi._validTerms,gi=fi._snd,li=fi._fst,hi=fi._labelName,mi=fi._symbol,k=fi.call_,ti=fi.token_,function(){var e,t;return e=this.fromOrientedRange,this.fromOrientedRange=function(t){return e.call(this,t),this.$nodes=t.$nodes,this.$editing=t.$editing,this.$editMarker=t.$editMarker},t=this.toOrientedRange,this.toOrientedRange=function(e){return e=t.call(this,e),e.$nodes=this.$nodes,e.$editing=this.$editing,e.$editMarker=this.$editMarker,e}}.call(g.prototype),exports.Mode=function(t){function g(e,t){this.isSingleLineInput=e,this.editorInstance=t,this.handleRangeDeselect=Ci(this.handleRangeDeselect,this),this.handleCommandExecution=Ci(this.handleCommandExecution,this),this.replay=Ci(this.replay,this),this.removeMultiSelectKeyboardHandler=Ci(this.removeMultiSelectKeyboardHandler,this),this.addMultiSelectKeyboardHandler=Ci(this.addMultiSelectKeyboardHandler,this),this.createMultiSelectKeyboardHandler=Ci(this.createMultiSelectKeyboardHandler,this),this.handlePaste=Ci(this.handlePaste,this),this.handleCopy=Ci(this.handleCopy,this),this.handleClick=Ci(this.handleClick,this),this.handleMouseUp=Ci(this.handleMouseUp,this),this.handleMouseDown=Ci(this.handleMouseDown,this),this.detach=Ci(this.detach,this),this.closeTooltip=Ci(this.closeTooltip,this),this.docsTooltip=Ci(this.docsTooltip,this),this.createCompleter=Ci(this.createCompleter,this),this.tokensOnLine=Ci(this.tokensOnLine,this),this.$tokenizer={getLineTokens:function(e){return function(t,n,i,r){var o;return null==r&&(r=e.editor.session.getDocument()),(o=e.tokensOnLine(i,r))?{tokens:H(o)}:{tokens:[{value:t,type:"text"}]}}}(this)},un.implement(this.$tokenizer,a),this.$behaviour=void 0,this.completers=[this.completer=this.createCompleter()]}var m,v,y;return Ai(g,t),g.prototype.tokensOnLine=function(e,t){var n,i;return i=t.positionToIndex({row:e,column:0}),n=t.positionToIndex({row:e+1,column:0}),this.ast?lt(ni(this.ast),i,n):void 0},g.prototype.getTokenAt=function(e){var t,n,i;return i=this.tokensSurroundingPos(e),n=i[0],t=i[1],t&&kt(t)?t:n||t},g.prototype.getNextLineIndent=function(e,t,n){var i,r,o;return i=this.$getIndent(t),o=(t.match(/[\(\[\{]/g)||[]).length,r=(t.match(/[\)\]\}]/g)||[]).length,new Array(o-r+i.length/n.length+1).join(n)},m=/^(\s*)# ?/,v=/^\s*###(?!#)/,y=/^\s*/,g.prototype.toggleCommentLines=function(e,t,n,i){var r,o,s,a;for(s=new f(0,0,0,0),r=a=n;i>=n?i>=a:a>=i;r=i>=n?++a:--a)o=t.getLine(r),v.test(o)||(o=m.test(o)?o.replace(m,"$1"):o.replace(y,"$&# "),s.end.row=s.start.row=r,s.end.column=o.length+2,t.replace(s,o))},g.prototype.detachFromSession=function(){return this.editor.removeListener("mousedown",this.handleMouseDown),this.editor.removeListener("mouseup",this.handleMouseUp),this.editor.tokenTooltip.destroy(),this.editor.onPaste=this.__editorOnPaste,this.editor.getCopyText=this.__editorCopyText,this.editor.setOption("dragEnabled",!0),this.editor.setOption("enableBlockSelect",!0)},g.prototype.attachToEditor=function(e){var t;return t=e.session,this.editor=e,this.editor.completers=this.completers,this.editor.session.setUndoManager(this.createUndoManager()),e.setOption("dragEnabled",!1),e.setOption("enableBlockSelect",!1),this.editor.on("mousedown",this.handleMouseDown),this.editor.on("mouseup",this.handleMouseUp),this.editor.tokenTooltip=new n(this.editor),this.editor.tokenTooltip.setTooltipContentForToken=this.docsTooltip,this.__editorOnPaste=this.editor.onPaste,this.editor.onPaste=this.handlePaste,this.__editorCopyText=this.editor.getCopyText,this.editor.getCopyText=this.handleCopy,this.editor.selection.on("removeRange",this.handleRangeDeselect),this.editor.commands.on("afterExec",this.handleCommandExecution),this.createMultiSelectKeyboardHandler(),t.multiSelect.on("multiSelect",this.addMultiSelectKeyboardHandler),t.multiSelect.on("singleSelect",this.removeMultiSelectKeyboardHandler),this.editor.on("blur",this.detach),this.isSingleLineInput||this.addVerticalCommands(t),this.addCommands(t),this.initAst("")},g.prototype.setContent=function(e,t,n){var i,r,o;try{return null!=n&&this.reportModuleName(n),i=x(e,this.ast),o=Ct(this.ast),this.mutate(et({changeInTree:{added:i,at:o}},t?{selectionRange:t}:{tangibleSelection:{"in":i,out:o.out}})),this.handleCommandExecution()}catch(s){return r=s,console.error(r,r.stack),console.error(e),this.editor.insert(e)}},g.prototype.selectInitially=function(e){return this.initialSelection=e},g.prototype.tangibleSelectionFromRange=function(e){var t,n,i,r;return i=this.tangibleAtPos(e.start),t=this.tangibleAtPos(e.end),di(i["in"])?(n=M(i["in"][0]),r=M(t.out[0]),{"in":vn(i).slice(n,r),out:t.out}):t},g.prototype.initAst=function(e){return this.ast=this.isSingleLineInput?P.astizeExpressionWithWrapper(e):P.astizeList(e),""===e?this.mutate({tangibleSelection:Ct(this.ast)}):void 0},g.prototype.updateAst=function(e,t){var n;return null==t&&(t=[]),q(e,this.ast),this.$tokenizer._signal("update",{data:{rows:{first:1}}}),(ci(t)||!this.isAutocompleting())&&this.updateAutocomplete(),this.addErrorMarkers(t),(n=this.initialSelection)?(this.initialSelection=null,this.mutate({inSelection:at(n.name,this.ast)})):void 0},g.prototype.repositionAst=function(){var e,t,n,i,r,o,s,a;for(e=this.ast.start,s=[[this.ast,!0]],a=[];n=s.pop();)i=n[0],o=n[1],Rt(i)?o?(i.start=e,s.push([i,!1]),a.push(function(){var e,n;for(n=[],e=i.length-1;e>=0;e+=-1)t=i[e],n.push(s.push([t,!0]));return n}())):a.push(i.end=e):(r=e-i.start,i.start=e,i.end+=r,a.push(e=i.end));return a},g.prototype.addErrorMarkers=function(e){var t,n,i,r,o,s,a,c;return this.removeErrorMarkers(),this.errorMarkers=[],n=e[0],n&&(r=n.message,t=n.conflicts,r)?(this.errorMarkers=function(){var e,n,r;for(r=[],i=e=0,n=t.length;n>e;i=++e)c=t[i],c&&(s=dn(c))&&(a=yi(s),o=ct(this.ast,a.start,a.end)[0],r.push({node:o}));return r}.call(this),this.updateErrorMarkers()):void 0},g.prototype.updateErrorMarkers=function(){var e,t,n,i,r,o,s,a;for(this.removeErrorMarkers(),s=this.errorMarkers||[],a=[],r=0,o=s.length;o>r;r++)t=s[r],t.node&&(n=t.node,i=this.nodeRange(n),e=this.errorMarkerRange(i),a.push(t.id=this.editor.session.addMarker(e,"clazz",this.showError(i,e,n.tea),!0)));return a},g.prototype.removeErrorMarkers=function(){var e,t,n,i,r;for(i=this.errorMarkers||[],r=[],t=0,n=i.length;n>t;t++)e=i[t].id,e&&r.push(this.editor.session.removeMarker(e));return r},g.prototype.showError=function(e,t,n){var i;return i=function(){return function(n,i,r,o,s,a){var c;return c=e.isMultiLine()?" golem_error-origin-open":"",a.drawSingleLineMarker(n,t,"golem_error-origin"+c,s)}}(this),i.type=n,i},g.prototype.errorMarkerRange=function(e){var t;return e.isMultiLine()?(t=e.start.row,new f(t,e.start.column,t,this.editor.session.getScreenLastRowColumn(t))):e},g.prototype.doAutocomplete=function(e){var t,n,i,r;return n=this.editor,i=["Up","Down","Ctrl-Up|Ctrl-Home","Ctrl-Down|Ctrl-End","PageUp","PageDown"],(null!=e?e.command.autocomplete:void 0)&&((t=this.editedAtom())&&!Bt(t)&&!Wt(t)&&this.offsetToCursor(t)===t.symbol.length||this.isInserting())?this.openAutocomplete():n.completer&&(r=null!=e?e.command.name:void 0,xi.call(i,r)<0||t&&Wt(t))?n.completer.detach():void 0},g.prototype.openAutocomplete=function(){var e;return e=this.editor,!this.isAutocompleting()||this.isInserting()?(e.completer||(e.completer=new i(!this.isSingleLineInput)),this.closeTooltip(),e.completer.showPopup(e)):void 0},g.prototype.updateAutocomplete=function(){var e;return this.isAutocompleting()?this.editor.completer.updateCompletions():this.editor.isFocused()&&(this.isInserting()||(e=this.onlySelectedExpression())&&!e.tea)?this.openAutocomplete():void 0},g.prototype.isAutocompleting=function(){return this.editor.completer&&this.editor.completer.activated},g.prototype.createCompleter=function(){var e;return e={getCompletions:function(t){return function(n,i,r,o,s){var a,c,l,u,h,d;if(!(o&&(null!=(h=n.completer.completions)?h.filtered.length:void 0)>0))return l=i.getMode(),l.isEditing()?(u=l.editedAtom(),a=u.symbol):u=Zn(l.selectedTangible()),!u.tea||u.tea.ForAll||(null!=(d=u.assignable)?d.top:0)?u.inferredType?t.worker.call("availableTypes",[u.inferredType],function(t){var n,i,r;return s(null,function(){var o,s;s=[];for(i in t)o=t[i],r=o.type,n=o.docs,s.push({name:r,value:r,completer:e,docs:n});return s}())}):void s("error",[]):(c={type:u.tea,scope:u.scope,pattern:u.assignable,emptyCall:Tt(u.parent)},t.worker.call("matchingDefinitions",[c],function(t){var n,i,r,o,a,c;return s(null,function(){var s,l;l=[];for(a in t)s=t[a],c=s.type,o=s.score,r=s.rawType,n=s.arity,i=s.docs,l.push({name:a,value:a,completer:e,score:o,meta:c,rawType:r,arity:n,docs:i});return l}())}))}}(this),getDocTooltip:function(e){return function(t){t.rawType&&!t.docHTML&&(t.docHTML=e.createDocTooltipHtml(t))}}(this),insertMatch:function(){return function(e,t){var n,i,r;return r=t.value,n=e.session.getMode(),n.startGroupMutation(),n.removeSelected(),n.insertStringForward(r),Rt(i=n.onlySelectedExpression())&&n.mutate({tangibleSelection:ft(l,i)}),n.finishGroupMutation()}}(this)}},g.prototype.docsTooltip=function(e,t){var n,i,r,o,s;return n=function(e){return function(n){return t.setHtml(n),t.open(),e.activeTooltip=t}}(this),t.hideAndRemoveMarker(),(i=e.malformed)||Ft(e)&&(i=e.parent.malformed)?n(i):null!=e.scope?(r={name:e.symbol,scope:e.scope},this.worker.call("docsFor",[r],function(t){return function(i){return null!=i?n("name"===e.label&&i.rawType?t.prettyPrintTypeForDoc(i):t.createDocTooltipHtml(i)):void 0}}(this))):(o=(null!=(s=e.type)?s.type:void 0)||e.tea)?n(this.prettyPrintTypeForDoc({rawType:o})):void 0},g.prototype.lookupSource=function(e,t){var n;return n={name:e.symbol,scope:e.scope},this.worker.call("docsFor",[n],function(){return function(e){var n,i,r,o,s;return o=e.source,Mt(o)&&(s=vi(o),n=s[0],i=s[1],r=3<=s.length?Si.call(s,2):[],o=k(n,Yt([i],nt(Lt,r)))),t(J(o))}}(this))},g.prototype.closeTooltip=function(){return this.detach()},g.prototype.detach=function(){var e;return null!=(e=this.activeTooltip)?e.hideAndRemoveMarker():void 0},g.prototype.createDocTooltipHtml=function(e){var t;return"<span style='color: #9EE062'>"+e.name+"</span>"+(e.arity?(t=e.arity||[]," <span style='color: #9C49B6'>"+t.join(" ")+"</span>"):"")+"\n"+(e.rawType?""+this.prettyPrintTypeForDoc(e)+"\n":"")+(e.docs?P.labelDocs(e.docs,t):"")},g.prototype.prettyPrintTypeForDoc=function(e){var t;return t=e.rawType,P.prettyPrint(t)},g.prototype.handleMouseDown=function(){return this.mouseDownTime=+new Date},g.prototype.handleMouseUp=function(e){return e.duration=new Date-this.mouseDownTime,e.preventDefault(),this.handleClick(e)},g.prototype.handleClick=function(e){var t;return t=200,e.duration>t?this.editor.execCommand("edit by click"):e.domEvent.shiftKey?this.editor.execCommand("expand selection by click"):this.ast?this.editor.execCommand("select by click"):void 0},g.prototype.handleCopy=function(){var e,t;return t=this.editor.getSelectedText(),e=z(Zn(this.selectedTangible())),e>0?t.replace(new RegExp("\\n"+Array(2*e+1).join(" "),"g"),"\n"):t},g.prototype.handlePaste=function(e){var t,n;return t=e.split(/(?:\r\n|\r|\n)(?!\s)/),n=this.editor.selection.rangeList.ranges,t.length>n.length||t.length<2||!t[1]?this.editor.commands.exec("insertstring",this.editor,e):(this.startGroupMutation(),this.editor.forEachSelection({exec:function(e){return function(){return e.insertStringForward(t[e.editor.selection.index])}}(this)}),this.finishGroupMutation(),this.handleCommandExecution({command:{name:"paste"}}))},g.prototype.undoManager=function(){var e;return e=this.editor.session.getUndoManager()},g.prototype.createUndoManager=function(){return new o(this)},g.prototype.addVerticalCommands=function(){return this.editor.commands.addCommands({"move up to atom or position":{bindKey:{win:"Up",mac:"Up"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectLineAdjecentAtomOrPosition(p)}}(this)},"move down to atom or position":{bindKey:{win:"Down",mac:"Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectLineAdjecentAtomOrPosition(d)}}(this)},"add a new sibling expression on the next line":{bindKey:{win:"Enter",mac:"Enter"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.replaceSpace(l,"\n")}}(this)},"add a new sibling expression on the previous line":{bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},multiSelectAction:"forEach",exec:function(t){return function(){return t.replaceSpace(e,"\n")}}(this)},"select the next reference of selection":{bindKey:{win:"Tab",mac:"Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(e){return function(){return e.selectReferenceInDirection(l)}}(this)},"select the previous reference of selection":{bindKey:{win:"Shift-Tab",mac:"Shift-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(t){return function(){return t.selectReferenceInDirection(e)}}(this)}})},g.prototype.createMultiSelectKeyboardHandler=function(){return this.multiSelectKeyboardHandler=new u([{name:"escape multi select",bindKey:"esc",scrollIntoView:"cursor",readonly:!0,exec:function(e){return function(){var t,n,i;return n=e.editor.selection,i=n.ranges,t=i[i.length-1],n.toSingleRange(t)}}(this),isAvailable:function(e){return function(){return e.isMultiSelecting()}}(this)}])},g.prototype.addMultiSelectKeyboardHandler=function(){return this.editor.keyBinding.addKeyboardHandler(this.multiSelectKeyboardHandler)},g.prototype.removeMultiSelectKeyboardHandler=function(){return this.editor.keyBinding.removeKeyboardHandler(this.multiSelectKeyboardHandler)},g.prototype.addCommands=function(){return this.editor.commands.addCommands({insertstring:{multiSelectAction:"forEach",scrollIntoView:"cursor",autocomplete:!0,exec:function(e){return function(t,n){return e.insertStringForward(n)}}(this)}}),this.editor.commands.addCommands(this.commands={ignoretheseshortcuts:{bindKey:{win:"Ctrl-Shift-E",mac:"Ctrl-Shift-E|Command-G|Command-Shift-G|Ctrl-G|Ctrl-Shift-G|Command-Shift-Up|Shift-Up|Shift-Down|Ctrl-N|Option-Shift-Left|Option-Shift-Right|Command-Shift-Left|Command-Shift-Right|Ctrl-B|Ctrl-V|Command-Option-E|Command-Shift-E|Command-D|Command-Shift-D duplicateSelection|Command-Alt-S|Command-/|Command-Shift-/|Command-Option-Up|Command-Option-Down|Command-Delete|Ctrl-H|Alt-Delete|Alt-Backspace|Ctrl-Alt-Backspace|Ctrl-[|Ctrl-]|Ctrl-Shift-U|Command-Shift-L|Ctrl-Alt-Up|Ctrl-Alt-Down|Ctrl-Alt-Shift-Up|Ctrl-Alt-Shift-Down|Ctrl-Alt-Left|Ctrl-Alt-Right|Ctrl-Alt-Shift-Left|Ctrl-Alt-Shift-Right|Ctrl-Alt-L|Ctrl-Alt-A|Ctrl-Alt-G"},exec:function(){return function(){}}(this)},"select by click":{autocomplete:!0,exec:function(e){return function(){return e.mutate({tangibleSelection:e.tangibleAtPos(e.cursorPosition())})}}(this)},"edit by click":{multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t,n;return n=e.tangibleAtPos(e.cursorPosition()),t=ln(n),e.mutate(t&&Et(t)?{withinAtom:t,withinAtomPos:e.offsetToCursor(t)}:{tangibleSelection:n})}}(this)},"expand selection by click":{multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i;return i=$n([e.selectedTangible(),e.tangibleAtPos(e.cursorPosition())]),t=i[0],n=i[1],e.mutate({tangibleSelection:Hn(t,n)})}}(this)},cut:{scrollIntoView:"cursor",multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t;return t=e.editor.getSelectionRange(),e.editor._emit("cut",t),e.remove(l)}}(this)},find:{bindKey:{win:"Ctrl-Shift-F",mac:"Command-F"},readOnly:!0,exec:function(e){return function(){return e.isSingleLineInput?void 0:r.Search(e.editor)}}(this)},selectall:{bindKey:{win:"Ctrl-A",mac:"Command-A"},readOnly:!0,exec:function(e){return function(){return e.mutate({tangibleSelection:Ct(e.ast)})}}(this)},"select enclosing expression":{bindKey:{win:"Ctrl-Up",mac:"Command-Up"},multiSelectAction:"forEach",exec:function(e){return function(){return e.mutate({inSelection:e.isEditing()?e.editedAtom():e.realParentOfSelected()})}}(this)},"select the first expression inside selection":{bindKey:{win:"Ctrl-Down",mac:"Command-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveDown(c,h)}}(this)},"select the last expression inside selection":{bindKey:{win:"Ctrl-Shift-Down",mac:"Command-Shift-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveDown(h,c)}}(this)},"move to next atom or position":{bindKey:{win:"Right",mac:"Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectFollowingAtomOrPosition(d)}}(this)},"move to previous atom or position":{bindKey:{win:"Left",mac:"Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectFollowingAtomOrPosition(p)}}(this)},"select next sibling expression":{bindKey:{win:"Ctrl-Right",mac:"Command-Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectSibling(d)}}(this)},"select previous sibling expression":{bindKey:{win:"Ctrl-Left",mac:"Command-Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.selectSibling(p)}}(this)},"include next expression in selection":{bindKey:{win:"Shift-Right",mac:"Shift-Right"},multiSelectAction:"forEach",exec:function(e){return function(){return e.expandSelection(d)}}(this)},"include previous expression in selection":{bindKey:{win:"Shift-Left",mac:"Shift-Left"},multiSelectAction:"forEach",exec:function(e){return function(){return e.expandSelection(p)}}(this)},"add new sibling expression":{bindKey:{win:"Space",mac:"Space"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertSpace(l," ")}}(this)},"add new sibling expression before current":{bindKey:{win:"Shift-Space",mac:"Shift-Space"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.insertSpace(e," ")}}(this)},removeback:{bindKey:{win:"Backspace",mac:"Backspace"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.remove(e)}}(this)},removeforward:{bindKey:{win:"Delete",mac:"Delete|Shift-Delete|Ctrl-Backspace|Shift-Backspace"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.remove(l)}}(this)},"flatten onto a single line":{bindKey:{win:"Ctrl-Space",mac:"Ctrl-Space"},multiSelectAction:"forEach",exec:function(e){return function(){return e.removeNewLines()}}(this)},"jump to next occurence of the selection":{bindKey:{win:"Ctrl-Tab",mac:"Alt-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(e){return function(){return e.selectOccurenceInDirection(l)}}(this)},"jump to previous occurence of the selection":{bindKey:{win:"Ctrl-Shift-Tab",mac:"Alt-Shift-Tab"},scrollIntoView:"center",multiSelectAction:"forEach",exec:function(t){return function(){return t.selectOccurenceInDirection(e)}}(this)},"multiselect next reference":{bindKey:{win:"Ctrl-S",mac:"Ctrl-S"},scrollIntoView:"center",exec:function(e){return function(){return e.multiSelectReferenceInDirection(l)}}(this)},"multiselect previous reference":{bindKey:{win:"Ctrl-Shift-S",mac:"Ctrl-Shift-S"},scrollIntoView:"center",exec:function(t){return function(){return t.multiSelectReferenceInDirection(e)}}(this)},"shift expression backward":{bindKey:{win:"Alt-Left",mac:"Alt-Left"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.moveSelection(e)}}(this)},"shift expression forward":{bindKey:{win:"Alt-Right",mac:"Alt-Right"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveSelection(l)}}(this)},"shift all expressions on a line up":{bindKey:{win:"Alt-Up",mac:"Alt-Up"},multiSelectAction:"forEach",autocomplete:!0,exec:function(t){return function(){return t.moveSelectionByLine(e)}}(this)},"shift all expressions on a line down":{bindKey:{win:"Alt-Down",mac:"Alt-Down"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.moveSelectionByLine(l)}}(this)},"insert a character":{bindKey:{win:"\\",mac:"\\"},multiSelectAction:"forEach",exec:function(e){return function(){return e.insertStringForward(e.isEditingHalfDelimited()?"\\":"\\_")}}(this)},"wrap in a call":{bindKey:{win:"Ctrl-Shift-9",mac:"Command-Shift-9"},logicalKey:{win:"Ctrl-(",mac:"Command-("},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.wrap("(",{insert:!0}," ",{selected:!0},")")}}(this)},"wrap in parentheses":{bindKey:{win:"(",mac:"("},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("(",")")}}(this)},"wrap in brackets":{bindKey:{win:"[",mac:"["},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("[","]")}}(this)},"wrap in braces":{bindKey:{win:"{",mac:"{"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.insertOpeningDelim("{","}")}}(this)},"insert or surround by quotes":{bindKey:{win:'"',mac:'"'},multiSelectAction:"forEach",exec:function(e){return function(){var t,n;return e.isEditingHalfDelimited()?"string"===(t=e.editedAtom()).label&&e.isAtLimit(l,t)?e.mutate({inSelection:t}):e.insertStringForward('"'):(n=Z('"',e.selectedText()),t=x('"'+n+'"',e.parentOfSelected())[0],e.mutate(et({changeInTree:{added:[t],at:e.selectedTangible()}},e.isSelecting()?{inSelection:t}:{withinAtom:t,withinAtomPos:n.length+1})))}}(this)},"select enclosing form or insert )":{bindKey:{win:")",mac:")"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert(")")}}(this)},"select enclosing form or insert }":{bindKey:{win:"}",mac:"}"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert("}")}}(this)},"select enclosing form or insert ]":{bindKey:{win:"]",mac:"]"},multiSelectAction:"forEach",exec:function(e){return function(){return e.closeParentOrInsert("]")}}(this)},"increment a number":{bindKey:{win:"Ctrl-Shift-Up",mac:"Alt-Shift-Up"},multiSelectAction:"forEach",exec:function(e){return function(){return e.changeNumerical(1)}}(this)},"decrement a number":{bindKey:{win:"Ctrl-Shift-Down",mac:"Alt-Shift-Down"},multiSelectAction:"forEach",exec:function(e){return function(){return e.changeNumerical(-1)}}(this)},"select enclosing definition":{bindKey:{win:"Ctrl-Shift-0",mac:"Command-Shift-0"},logicalKey:{win:"Ctrl-)",mac:"Command-)"},multiSelectAction:"forEach",exec:function(e){return function(){return e.mutate({inSelection:K(on(c,e.selectedTangible()))})}}(this)},addlabel:{bindKey:{win:":",mac:":"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t,n,i,r;return e.isSingleLineInput&&""===e.editor.getValue()?!1:e.isEditingHalfDelimited()?e.insertStringForward(":"):(t=e.onlySelectedExpression(),e.mutate(e.isEditing()||t&&Et(t)?(n=t.symbol.length,{changeWithinAtom:{string:":",atom:t,range:[n,n]}}):(r=x(":",e.parentOfSelected()),i=r[0],r,{changeInTree:{added:[i],at:e.selectedTangible()},withinAtom:i,withinAtomPos:0})))}}(this)},"insert a comment":{bindKey:{win:"#",mac:"#"},multiSelectAction:"forEach",exec:function(e){return function(){return e.isEditingHalfDelimited()?e.insertStringForward("#"):e.wrap("(","#"," ",{selected:!0,select:!0},")")}}(this)},"go to definition":{bindKey:{win:"Ctrl-E",mac:"Ctrl-E"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r,o,s,a,c;if(n=function(t){return e.editorInstance.executeCommand("load",t)},o=e.onlySelectedExpression(),o&&Et(t=o)){if(null!=t.id){for(r=ot(t)(e.ast),c=[],s=0,a=r.length;a>s;s++)if(i=r[s],Pt(i)){i.imported?(e.selectInitially({name:i.imported.name}),n(i.imported.module)):e.mutate({inSelection:i});break}return c}if("module"===t.label)return e.editorInstance.executeCommand("load",t.symbol)}}}(this)},"insert call-site type":{bindKey:{win:"Ctrl-T",mac:"Ctrl-T"},indirect:!0,autocomplete:!0,exec:function(e){return function(t,n){var i,r,o,s,a;return r=(null!=n?n:{}).targetEditor,r&&(o=r.session.getMode(),i=o.onlySelectedExpression(),i&&i.tea)?(s=P.plainPrettyPrint(i.tea),a=s.replace(/_\d+/,""),e.startGroupMutation(),e.insertStringForward("(: "+a+")"),e.mutate({tangibleSelection:ft(l,e.onlySelectedExpression())}),e.finishGroupMutation()):void 0}}(this)},"show type of an expression":{bindKey:{win:"Ctrl-Shift-T",mac:"Ctrl-Shift-T"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n;if(n=e.selectedTangible(),t=ln(n)||tt(n)){if(t.malformed)return window.log(t.malformed);if(t.tea)return window.log(P.prettyPrint(t.tea))}}}(this)},"remove all source":{bindKey:{win:"Ctrl-Shift-Backspace",mac:"Ctrl-Shift-Backspace"},document:!1,exec:function(e){return function(){return e.editor.setValue(""),e.initAst("")}}(this)},"replace enclosing Parent expression with current selection":{bindKey:{win:"Ctrl-P",mac:"Ctrl-P"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r;return r=e.realParentOfSelected(),r?(t=e.selectedTangible(),i=Dn(t,r.parent),n=bt([r]),e.mutate({changeInTree:{added:i,at:n},inSelections:di(i)?i:void 0,tangibleSelection:ci(i)?pn(n.out):void 0})):void 0}}(this)},"wrap current selection in a Function":{bindKey:{win:"Ctrl-F",mac:"Ctrl-F"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){var t;return t=!Vt(e.selectedTangible())||e.isSingleLineInput?[" "]:["\n","  "],e.isInserting()?e.wrap.apply(e,["(","fn"," ",["[",{insert:!0},"]"]].concat(Si.call(t),[{selected:!0}],[")"])):e.wrap("(","fn"," ","[]"," ",{selected:!0,select:!0},")")}}(this)},"Match on current selection":{bindKey:{win:"Ctrl-M",mac:"Ctrl-M"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.isInserting()?e.wrap("(","match"," ",{selected:!0,insert:!0},"\n","  "," ",")"):e.wrap("(","match"," ",{selected:!0},"\n","  ",{insert:!0}," ",")")}}(this)},"wrap in a Match to return current selection":{bindKey:{win:"Ctrl-Shift-M",mac:"Ctrl-Shift-M"},multiSelectAction:"forEach",autocomplete:!0,exec:function(e){return function(){return e.wrap("(","match"," ",{insert:!0},"\n","  "," ",{selected:!0},")")}}(this)},"replace selection with an Added function parameter":{bindKey:{win:"Ctrl-Shift-A",mac:"Ctrl-A"},exec:function(e){return function(){var t,n,i,r;return r=$n(e.selectedTangiblesList())[0],r&&(n=dt(Zn(r))),n&&(i=ht(n)),i?(t=pn(i.slice(-1)),e.mutate(et(di(vi(i))?{changeInTree:{added:x(" ",i),at:t}}:{},{newSelections:[t]}))):void 0}}(this)},"select all occurences of selection to Rename":{bindKey:{win:"Ctrl-R",mac:"Ctrl-R"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r;return i=e.onlySelectedExpression(),i&&Et(t=i)?(n=ut(t)(e.ast),r=Zt(ei,n),e.mutate({inSelection:t,newSelections:r})):void 0}}(this)},"Define selected token":{bindKey:{win:"Ctrl-D",mac:"Ctrl-D"},indirect:!0,exec:function(e){return function(t,n){var i,r,o,s,a,c,u,d,p,f,g,m,v,y,b,w,E;return b=(null!=n?n:{}).targetEditor,null==b&&(b=e.editor),w=b.session.getMode(),g=w.onlySelectedExpression(),g&&Et(r=g)&&r.malformed?(e.startGroupMutation(),b!==e.editor?e.insertStringForward(Ut(r)?(i=A(r.parent),""+r.symbol+" (fn ["+i.join(" ")+"]\n  )"):""+r.symbol+" "):(E=C(g),c=on(h,ei(E)),y=mn(E)?"\n":"\n\n",e.insertSpaceAt(l,y,c),e.insertStringForward(Ut(r)?(i=A(r.parent),""+r.symbol+" (fn ["+i.join(" ")+"]\n  )"):""+r.symbol+" ")),s=o=e.selectableEdge(h),Ut(r)&&(s=zn(h,Zn(o))),e.mutate({tangibleSelection:s}),e.finishGroupMutation()):g?b!==e.editor?(a=Dn(ei(g),e.parentOfSelected()),e.startGroupMutation(),d=T(e.selectedTangible()),e.insertSpace(l," "),e.mutate({changeInTree:{added:a,at:e.selectedTangible()},tangibleSelection:d()}),e.finishGroupMutation()):(E=C(g),c=on(h,ei(E)),a=Dn(e.selectedTangible(),E.parent),y=mn(E)?"\n":"\n\n",e.startGroupMutation(),v=e.selectedTangiblesList(),p=function(){var e,t,n;for(n=[],e=0,t=v.length;t>e;e++)m=v[e],this.mutate(this.removeSelectable(m)),n.push(T(this.selectedTangible()));return n}.call(e),e.insertSpaceAt(l,y,c),u=T(e.selectedTangible()),e.insertSpaceAt(l," ",c),f=yn(p),e.mutate({changeInTree:{added:a,at:{"in":[],out:[c]}},tangibleSelection:f[0],newSelections:Yt(f.slice(1),[u()])}),e.finishGroupMutation()):void 0}}(this)},"Inline selected expression or replace a name by its definition":{bindKey:{win:"Ctrl-I",mac:"Ctrl-I"},multiSelectAction:"forEach",exec:function(t){return function(){var n,i,r,o,s,a,c,u,h,d,p,f,g,m,v,y,b,w,C,E,A,x,S,_,F,D,T,k;if(E=t.onlySelectedExpression(),E&&Et(r=E)){if(!Pt(r))return Nt(r)?t.worker.call("expand",[r.parent],function(e){var n;return e?(n=_n([J(e)],r.parent.parent),t.mutate({changeInTree:{added:n,at:ei(r.parent)},inSelections:n})):void 0}):t.lookupSource(r,function(e){var n;return n=_n([e],r.parent),t.mutate({changeInTree:{added:n,at:t.selectedTangible()},inSelections:n})});if(g=ut(r)(t.ast),t.startGroupMutation(),(v=mn(r))&&(c=mn(v))&&Ut(c)&&Mt(c)&&ht(c)===v?(i=In(Zt(mi,bi(v)),c.parent),m=vi(v).indexOf(r),m<i.length&&i[m]&&(d=ei(i[m]),t.mutate({changeInTree:{at:Qn(d)}}),t.mutate({changeInTree:{at:Qn(ei(r))}}))):(s=On(l,r))&&kt(s)&&(d=ei(s),t.mutate(t.removeSelectable(Hn(ei(r),d))),t.mutate(t.remove(e)),t.isInserting()&&t.mutate(t.remove(e))),d){for(u=S=0,D=g.length;D>S;u=++S)f=g[u],h=Dn(d,f.parent),t.mutate({changeInTree:{added:h,at:ei(f)}}),t.mutate(0===u?{inSelections:h}:{newSelections:[bt(h)]});return t.finishGroupMutation()}}else if(E&&xt(b=E)||mn(E)&&xt(b=mn(E))){for(a=pi(b),y=bi(ht(a)),i=ai(b),t.startGroupMutation(),u=_=0,T=i.length;T>_;u=++_)if(n=i[u],u<y.length)for(x=ut(y[u])(b),F=0,k=x.length;k>F;F++)A=x[F],h=Dn(ei(n),A.parent),t.mutate({changeInTree:{added:h,at:ei(A)}});return i.length===y.length?(o=vi(a)[2],w=Dn(ei(o),b.parent),t.mutate({changeInTree:{added:w,at:ei(b)},inSelections:w})):(p=Math.min(i.length,y.length),t.mutate({changeInTree:{at:Xn(Hn(ei(y[0]),ei(y[p-1])))}}),t.mutate({changeInTree:{at:Xn(Hn(ei(i[0]),ei(i[p-1])))}}),i.length<y.length&&(C=Dn(ei(a),b.parent),t.mutate({changeInTree:{added:C,at:ei(b)},inSelections:C}))),t.finishGroupMutation()}}}(this)},"abstract an operator with a Lambda":{bindKey:{win:"Ctrl-L",mac:"Ctrl-L"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r,o;if(t=function(t,n){var i,r,o,s,a,c;return i=n.join(" "),a=x("(fn ["+i+"] ( "+i+"))",t[0].parent),e.startGroupMutation(),e.mutate({changeInTree:{added:a,at:bt(t)},inSelections:a}),c=vi(a[0]),o=c[0],s=c[1],r=c[2],e.mutate({changeInTree:{added:_n(t,r),at:pn([r[1]])}}),e.finishGroupMutation()
},St(r=e.parentOfSelected())){if(Ut(Zn(o=e.selectedTangible())))return i=o["in"],n=A(r).slice(bi(i).length-1),t(i,n);if((i=e.onlySelectedExpression())&&Et(i))return e.worker.call("docsFor",[D(i)],function(e){return e.arity?(n=e.arity,t([i],n)):void 0})}}}(this)},"push a lambda inside of a call to the Outer expression":{bindKey:{win:"Ctrl-O",mac:"Ctrl-O"},multiSelectAction:"forEach",exec:function(e){return function(){var t,n,i,r,o,s,a;return(n=e.onlySelectedExpression())&&Mt(n)&&Ut(n)&&(t=mn(n.parent))?(e.startGroupMutation(),a=_n([st(n)],t),e.mutate({changeInTree:{added:a,at:ei(n.parent)}}),s=_n([n.parent],t.parent),i=s[0],r=pi(i),e.mutate({changeInTree:{added:s,at:ei(t)}}),o=_n([t],i),e.mutate({changeInTree:{added:o,at:ei(st(r))},inSelection:r}),e.finishGroupMutation()):void 0}}(this)},"push definition Up":{bindKey:{win:"Ctrl-U",mac:"Ctrl-U"},multiSelectAction:"forEach",exec:function(t){return function(){var n,i;return i=t.selectedTangible(),(n=function(r){var o,s,a,c,u,d,p,f,g,m,v,y,b;return v=C(r),s=Pt(v)?kt(o=On(l,v))?Hn(ei(v),ei(o)):void 0:Pt(u=On(e,v))?Hn(ei(u),ei(v)):void 0,s&&mn(v)?(p=C(v.parent),c=on(h,ei(p)),y=en(i),g=y[0],f=y[1],b=Tn(s,p.parent,g),a=b[0],d=b[1],m=mn(p)?"\n":"\n\n",t.startGroupMutation(),t.mutate(t.removeSelectable(s)),t.isInserting()&&t.mutate(t.remove(e)),t.insertSpaceAt(l,m,c),t.mutate({changeInTree:{added:a,at:{"in":[],out:[c]}},memorableSelection:[f,d]}),t.finishGroupMutation()):n(mn(r))})(Zn(t.selectedTangible()))}}(this)}})},g.prototype.multiSelectReferenceInDirection=function(e){var t,n,i;return i=this.onlySelectedExpression(),i&&Et(t=i)&&null!=t.id?(n=ot(t)(this.ast),this.mutate({newSelections:[ei(it(e,t,n))]})):this.multiSelectOccurenceInDirection(e)},g.prototype.multiSelectOccurenceInDirection=function(e){var t,n;return this.isInserting()?void 0:(n=this.selectedTangible()["in"],t=rt(n)(this.ast),this.mutate({newSelections:[bt(it(e,n,t))]}))},g.prototype.selectReferenceInDirection=function(e){var t,n,i;return i=this.onlySelectedExpression(),i&&Et(t=i)&&null!=t.id?(n=ot(t)(this.ast),this.mutate({inSelection:it(e,t,n)})):this.selectOccurenceInDirection(e)},g.prototype.selectOccurenceInDirection=function(e){var t,n;return this.isInserting()?void 0:(n=this.selectedTangible()["in"],t=rt(n)(this.ast),this.mutate({inSelections:it(e,n,t)}))},g.prototype.moveDown=function(e,t){var n;return this.mutate(this.isSelectingMultiple()?{tangibleSelection:this.selectableEdge(e)}:(n=this.onlySelectedExpression())?Rt(n)?{tangibleSelection:zn(e,n)}:{withinAtom:n,withinAtomPos:X(t,n)}:{})},g.prototype.changeNumerical=function(e){var t,n,i,r,o;return(t=this.onlySelectedExpression())&&Wt(t)?(o=this.offsetToCursor(t),i=R(t.symbol,o,e),n=x(i,t.parent)[0],r=this.isEditing(),this.mutate({changeInTree:{added:[n],at:this.selectedTangible()},inSelection:r?void 0:n,withinAtom:r?n:void 0,withinAtomPos:r?n.symbol.length-(t.symbol.length-o):void 0})):void 0},g.prototype.closeParentOrInsert=function(e){return this.isEditingHalfDelimited()?this.insertStringForward(e):this.mutate({inSelection:this.realParentOfSelected()})},g.prototype.insertOpeningDelim=function(e,t){return this.isEditingHalfDelimited()?this.insertStringForward(e):this.wrap(e,{selected:!0,select:!0},t)},g.prototype.wrap=function(){var e,t,n,i,r;return r=1<=arguments.length?Si.call(arguments,0):[],n=function(e){return"string"==typeof e},e=function(t){var i,r,o,s,a,c,l,u,h,d,p,f,g;for(h={},c=0,o=d=0,f=t.length;f>d;o=++d)if(u=t[o],!n(u))if(Array.isArray(u)){a=e(u);for(s in a)for(r=a[s],p=0,g=r.length;g>p;p++)i=r[p],l={},(null!=h[s]?h[s]:h[s]=[]).push({parent:o-c,child:i})}else{for(s in u)(null!=h[s]?h[s]:h[s]=[]).push(o-c);c++}return h},i=e(r),t=function(e){var i,r;return Array.isArray(e)?function(){var n,o,s;for(s=[],n=0,o=e.length;o>n;n++)r=e[n],(i=t(r))&&s.push(i);return s}().join(""):n(e)?e:void 0},this.wrapIn(t(r),this.selectedTangible(),i)},g.prototype.wrapIn=function(e,t,n){var i,r,o,s,a,c,l,u;if(a=n.selected,s=n.select,o=n.insert,null==a)throw new Error("missing selected in wrapIn");return u=x(e,vn(t))[0],r=0===t["in"].length,i=function(e,t){return e.parent?i(e.child,t[e.parent]):t[e]},this.startGroupMutation(),this.mutate({changeInTree:{added:[u],at:t}}),l=Dn(t,u),c=Yt(s||[],o||[]),this.mutate({changeInTree:{added:l,at:{"in":[],out:[i(a[0],u)]}},inSelections:s&&!r?l:void 0,tangibleSelection:!s||r?{"in":[],out:[i(c[0],u)]}:void 0,newSelections:Zt(function(e){return{"in":[],out:[i(e,u)]}},c.slice(1))}),this.finishGroupMutation()},g.prototype.removeNewLines=function(){var e,t,n,i;return i=this.selectedTangible(),t=i["in"],e=function(t){var n,i,r,o;for(o=[],i=0,r=t.length;r>i;i++)n=t[i],$t(n)||o.push(It(n)?x(" ",n.parent)[0]:Rt(n)?Qt(e(n)):B(n));return o},n=e(t),this.mutate({changeInTree:{added:n,at:i},inSelections:n})},g.prototype.moveSelectionByLine=function(e){var t,n,i,r;return i=this.selectedTangible(),r=bt(this.allOnLine(Zn(i))),(t=Mn(e,G(e,fn(e,r))))?(n=bt(this.allOnLine(t)),this.swap(e,r,n)):void 0},g.prototype.allOnLine=function(e){var t,n,i,r;return n=function(e){return function(t){var n;return n=e.rangeOfNodes([t]),n.start.row===n.end.row}}(this),t=function(e){return kt(e)||qt(e)},r=function(n){var i,r,o;for(i=e,o=[];(r=Mn(n,i))&&t(r);)o.push(i=r);return o},(i=mn(e))&&n(i)?this.allOnLine(i):I([r(c).reverse(),t(e)?[e]:[],r(h)])},g.prototype.moveSelection=function(e){var t,n,i;if(this.isEditing()){if(t=this.editedAtom(),!this.isAtLimit(e,t))return this.mutate({withinAtom:t,withinAtomPos:this.offsetToCursor(t)+e})}else if(i=this.selectedTangible(),n=this.selectedSibling(e))return this.swap(e,i,n)},g.prototype.swap=function(e,t,n){var i,r,o;return r=O(t["in"]),i=O(n["in"]),this.startGroupMutation(),this.mutate({changeInTree:{added:[],at:t}}),this.mutate({changeInTree:{added:i,at:{"in":[],out:t.out}}}),this.mutate({changeInTree:{added:[],at:n}}),o={"in":[],out:n.out},this.mutate({changeInTree:{added:r,at:o},inSelections:di(r)?r:void 0,tangibleSelection:ci(r)?o:void 0}),this.finishGroupMutation()},g.prototype.insertStringForward=function(e){return this.insertString(l,e)},g.prototype.insertString=function(e,t){var n,i,r,o,s;if(null==t)throw"Missing string in insertString";return this.mutate(this.isEditing()?(i=this.editedAtom(),s=Dt(i)?(r=_(i),Z(r,t)):t,o=this.offsetToCursor(i),{changeWithinAtom:{string:s,range:"char"===i.label&&"\\_"===i.symbol?[1,2]:[o,o]}}):(n=x(t,this.parentOfSelected()),et({changeInTree:{added:n,at:this.selectedTangible()}},1===n.length&&Et(i=n[0])?{withinAtom:i,withinAtomPos:i.symbol.length}:{inSelections:n})))},g.prototype.insertSpace=function(e,t){return this.isEditing()&&Dt(this.editedAtom())?this.insertString(e,t):this.insertSpaceAt(e,t,this.selectedNodeEdge(e))},g.prototype.replaceSpace=function(e,t){var n,i,r;return r=this.toSelectionSibling(e),n=r.margin,i=r.siblingTangible,n&&qt(G(hn(e),n["in"]))?this.mutate({changeInTree:{added:x(t,vn(n)),at:n},tangibleSelection:i}):this.insertSpace(e,t)},g.prototype.insertSpaceAt=function(e,t,n){var i,r;return r=n.parent,i=x(t,r),this.mutate({changeInTree:{added:i,at:{"in":[],out:[n]}},tangibleSelection:{"in":[],out:e===l?[n]:i}})},g.prototype.selectLineAdjecentAtomOrPosition=function(e){var t,n,i,r,o,s,a,l,u,h,d;return a=this.startPos(u=Zn(this.selectedTangible())),n=null!=(d=this.editor.selection.$desiredColumn)?d:a.column,l=a.row+e,t=this.tangibleAtPos({row:l,column:n+1}),h=Rt(i=Zn(t))?(o=this.startPos(i),r=this.edgeOfNode(e,i),s=r.row===l&&o.column>n?c:jt(u,i)?e:hn(e),Jn(Xt(s,Zn(t)))):t,this.mutate({tangibleSelection:h,desiredColumn:n})},g.prototype.selectFollowingAtomOrPosition=function(e){return this.isSelectingMultiple()?this.selectSibling(e):this.mutate({tangibleSelection:mt(e,this.selectedTangible())})},g.prototype.selectSibling=function(e){var t;return this.mutate(this.isSelectingMultiple()?{tangibleSelection:this.selectableEdge(e)}:(t=this.selectedSibling(e),!t&&zt(this.parentOfSelected())?{inSelection:this.parentOfSelected()}:{tangibleSelection:t}))},g.prototype.expandSelection=function(e){var t,n,i,r;return r=this.toSelectionSibling(e),t=r.margin,n=r.siblingTangible,this.mutate(n?(i=E(e,t,n),{tangibleSelection:E(e,this.selectedTangible(),i)}):{inSelection:this.realParentOfSelected()})},g.prototype.tangibleAtPos=function(e){var t,n,i,r;return r=this.tokensSurroundingPos(e),n=r[0],t=r[1],i=Gn(l,n,t||n)},g.prototype.tokenFollowingPos=function(e){var t,n,i;return i=this.tokensSurroundingPos(e),n=i[0],t=i[1],t||n},g.prototype.tokensSurroundingPos=function(e){var t;return t=this.trimmedPosToIdx(e),lt(this.ast,t-1,t+1)},g.prototype.tangibleRange=function(e){var t,n,i;return i=sn(e),n=i[0],t=i[1],bn(this.startPos(n),this.startPos(t))},g.prototype.remove=function(e){var t,n,i,r,o,s,a,u,d,f;return this.mutate((n=this.editedAtom())?t=Q(n)===(Dt(n)?0:1)?this.removeSelectable(this.selectedTangible()):(o=this.offsetToCursor(n),u=this.isAtLimit(e,n)?hn(e):e,{changeWithinAtom:{string:"",range:[o,o+u]}}):this.isSelecting()?this.removeSelectable(this.selectedTangible()):(f=this.selectedTangible(),i=this.selectionMargin(e),u=i?e:hn(e),d=this.selectionMargin(u),d?(a=Mn(p,on(c,d)),r=on(h,d),{changeInTree:{at:d},tangibleSelection:Gn(l,a,r)}):zt(s=this.parentOfSelected())?this.removeSelectable(bt([s])):{}))},g.prototype.removeSelected=function(){return this.isInserting()?void 0:this.mutate(this.removeSelectable(this.selectedTangible()))},g.prototype.removeSelectable=function(e){return{changeInTree:{at:e},tangibleSelection:{"in":[],out:e.out}}},g.prototype.isAtLimit=function(e,t){var n;return n=this.distance(this.cursorPosition(),this.editableEdge(e,t)),0===n},g.prototype.offsetToCursor=function(e){return this.distance(this.cursorPosition(),this.startPos(e))},g.prototype.selectedText=function(){return this.isEditing()?this.editedAtom().symbol:this.editor.getSelectedText()},g.prototype.selectableEdge=function(e){return Un(e,this.selectedTangible())},g.prototype.editableEdge=function(e,t){return Dt(t)?this.idxToPos(V(e,t)+hn(e)):this.edgeOfNode(e,t)},g.prototype.realParentOfSelected=function(){var e;return zt(e=this.parentOfSelected())?e:void 0},g.prototype.parentOfSelected=function(){return vn(this.selectedTangible())},g.prototype.selectedSibling=function(e){return this.toSelectionSibling(e).siblingTangible},g.prototype.toSelectionSibling=function(e){var t,n;return t=this.selectionMargin(e),t?(n=fn(e,t),{margin:t,siblingTangible:Gn(e,G(e,t["in"]),G(hn(e),n))}):{}},g.prototype.selectionMargin=function(e){return qn(e,this.selectedTangible())},g.prototype.selectedNodeEdge=function(e){return on(e,this.selectedTangible())},g.prototype.editedAtom=function(){return this.isEditing()?this.onlySelectedExpression():void 0},g.prototype.onlySelectedExpression=function(){return ln(this.selectedTangible())},g.prototype.startGroupMutation=function(){return this.groupMutating=!0},g.prototype.finishGroupMutation=function(){return this.groupMutating=!1,this.undoManager().packGroupMutation()},g.prototype.registerMutation=function(e,t){var n,i,r;return i=this.isEditing()?(n=this.editedAtom(),{withinAtom:n,withinAtomPos:this.distance(this.startPos(n),this.editor.selection.getRange().end)}):{tangibleSelection:this.selectedTangible()},"function"==typeof(r=this.undoManager()).registerMutation?r.registerMutation(e,i,t):void 0},g.prototype.replay=function(e,t){var n,i,r,o;if(i=e.pop()){for(this.startGroupMutation(),r=0,o=i.length;o>r;r++)n=i[r],this.mutate(n,t);return this.finishGroupMutation()}},g.prototype.mutate=function(e,t){var n,i,r,o,s,a,c,l,u,h,d,p,f,g,m,v,y;if(null==t&&(t={undo:!0}),this.registerMutation(e,t),this.groupMutating||"function"==typeof(f=this.undoManager()).packGroupMutation&&f.packGroupMutation(),e.changeInTree&&(l=e.changeInTree.at,n=e.changeInTree.added||[],c=this.rangeOfTangible(l),i=cn(n),b(l,n)),e.changeWithinAtom){if(c)throw"atom edit during tree edit not supported";l=e.changeWithinAtom.range,n=e.changeWithinAtom.string,r=e.changeWithinAtom.atom||this.editedAtom(),c=this.rangeWithingAtom(r,l),i=n,w(r,l,n)}if(null!=i&&(this.repositionAst(),this.docReplace(c,i)),(e.inSelection||e.inSelections||e.tangibleSelection||e.selectionRange||e.memorableSelection)&&(d=e.tangibleSelection||e.selectionRange&&this.tangibleSelectionFromRange(e.selectionRange)||e.memorableSelection&&(v=e.memorableSelection,a=v[0],u=v[1],v)&&a(u)||bt(e.inSelections||[e.inSelection]),h=this.rangeOfTangible(d),o=!1),e.withinAtom){if(d)throw"shouldn't set both withinAtom and selection";d=bt([e.withinAtom]),h=this.rangeWithingAtom(e.withinAtom,[e.withinAtomPos,e.withinAtomPos]),o=!0}if(d&&(this.select(d,o),this.setSelectionRange(h,e.desiredColumn)),e.newSelections)for(y=e.newSelections,g=0,m=y.length;m>g;g++)p=y[g],s=this.tangibleRange(p),this.selectFor(p,!1,s),this.editor.selection.addRange(s);return!0},g.prototype.handleCommandExecution=function(e){return this.updateEditingMarkers(),this.updateErrorMarkers(),this.closeTooltip(),this.doAutocomplete(e)},g.prototype.select=function(e,t){return this.editor.selection.$nodes=e,this.editor.selection.$editing=t},g.prototype.selectFor=function(e,t,n){return n.$nodes=e,n.$editing=t},g.prototype.setSelectionRange=function(e,t){return this.editor.selection.setSelectionRange(e),this.editor.selection.$desiredColumn=t},g.prototype.updateEditingMarkers=function(){var e,t,n,i,r;for(e=this.isMultiSelecting()?this.editor.multiSelect.ranges:[this.editor.selection],t=i=0,r=e.length;r>i;t=++i)n=e[t],this.updateEditingMarkerFor(this.isEditingFor(n),n)},g.prototype.updateEditingMarkerFor=function(e,t){var n,i,r;return(i=t.$editMarker)&&(this.editor.session.removeMarker(i),t.$editMarker=void 0),e?(n=ln(t.$nodes),r=this.editableRange(n),i=this.editor.session.addMarker(r,"ace_active-token"),t.$editMarker=i):void 0},g.prototype.isMultiSelecting=function(){return this.editor.multiSelect.inMultiSelectMode},g.prototype.selectedTangiblesList=function(){var e,t,n,i;if(this.isMultiSelecting()){for(n=this.editor.multiSelect.ranges,i=[],t=n.length-1;t>=0;t+=-1)e=n[t],i.push(e.$nodes);return i}return[this.selectedTangible()]},g.prototype.selectedTangible=function(){return this.editor.selection.$nodes},g.prototype.isEditing=function(){return this.editor.selection.$editing},g.prototype.isEditingFor=function(e){return e.$editing},g.prototype.isEditingDelimited=function(){return this.isEditing()&&Dt(this.editedAtom())},g.prototype.isEditingHalfDelimited=function(){return this.isEditing()&&Bt(this.editedAtom())},g.prototype.isSelecting=function(){return!this.isEditing()&&this.selectedTangible()["in"].length>0},g.prototype.isSelectingMultiple=function(){return this.isSelecting()&&this.selectedTangible()["in"].length>1},g.prototype.isInserting=function(){return 0===this.selectedTangible()["in"].length},g.prototype.toText=function(e){return this.editor.session.doc.getTextRange(this.range(e))},g.prototype.editableRange=function(e){return Dt(e)?this.delimitedAtomRange(e):this.range(e)},g.prototype.cursorPosition=function(){return this.editor.getCursorPosition()},g.prototype.handleRangeDeselect=function(e){var t,n,i,r,o;for(n=e.ranges,o=[],i=0,r=n.length;r>i;i++)t=n[i],o.push(this.updateEditingMarkerFor(!1,t));return o},g.prototype.delimitedAtomRange=function(e){var t,n,i;return i=this.range(e),n=i.start,t=i.end,f.fromPoints(this.shiftPosBy(n,1),this.shiftPosBy(t,-1))},g.prototype.rangeWithingAtom=function(e,t){var n,i,r;return r=Pn(t),i=r[0],n=r[1],f.fromPoints(this.idxToPos(e.start+i),this.idxToPos(e.start+n))},g.prototype.rangeOfNodes=function(e){var t,n;return t=e[0],n=e[e.length-1],bn(this.startPos(t),this.endPos(n))},g.prototype.rangeOfTangible=function(e){var t,n,i;return i=sn(e),t=i[0],n=i[1],bn(this.startPos(t),this.startPos(n))},g.prototype.range=function(e){var t,n;return n=this.startPos(e),t=this.endPos(e),f.fromPoints(n,t)},g.prototype.endOfLine=function(e){return this.idxToPos(this.posToIdx({row:e.row+1,column:0})-1)},g.prototype.edgeOfNode=function(e,t){return this.idxToPos(V(e,t))},g.prototype.nodeRange=function(e){return bn(this.startPos(e),this.endPos(e))},g.prototype.startPos=function(e){return this.idxToPos(e.start)},g.prototype.endPos=function(e){return this.idxToPos(e.end)},g.prototype.distance=function(e,t){return Math.abs(this.posToIdx(t)-this.posToIdx(e))},g.prototype.idxToPos=function(e){return this.editor.session.doc.indexToPosition(e)},g.prototype.posToIdx=function(e){return this.editor.session.doc.positionToIndex(e)},g.prototype.trimmedPosToIdx=function(e){return this.posToIdx(this.editor.session.$clipPositionToDocument(e.row,e.column))},g.prototype.shiftPosBy=function(e,t){return this.idxToPos(this.posToIdx(e)+t)},g.prototype.docReplace=function(e,t){var n;return n=this.editor.session.doc,n.remove(e),n.insert(e.start,t)},g.prototype.prepareWorker=function(){var e;return e=new s(["ace","compilers"],"compilers/teascript/worker","Worker",null),this.worker=e},g.prototype.createWorker=function(e){if(!this.worker)throw new Error("Missing worker in mode");return this.worker.attachToDocument(e.getDocument()),this.worker.on("error",function(t){return e.setAnnotations([t.data])}),this.worker.on("ok",function(){return function(){return e.clearAnnotations()}}(this)),this.worker},g.prototype.reportModuleName=function(e){return e!==this.moduleName?(this.moduleName=e,this.worker.call("setModuleName",[e])):void 0},g}(m),o=function(){function e(e){this.mode=e,this.reset=Ci(this.reset,this),this.redo=Ci(this.redo,this),this.undo=Ci(this.undo,this),this.packGroupMutation=Ci(this.packGroupMutation,this),this.registerMutation=Ci(this.registerMutation,this),this.execute=Ci(this.execute,this),this.reset()}return e.prototype.execute=function(){},e.prototype.registerMutation=function(e,t,n){var i,r,o,s,a,c,l,u;return c=n.undo?this.undoStack:this.redoStack,a=[],e.changeInTree&&(s=e.changeInTree.at,i=e.changeInTree.added||[],a.push({changeInTree:{at:{"in":i,out:s.out},added:s["in"]}})),e.changeWithinAtom&&(u=Pn(e.changeWithinAtom.range),o=u[0],l=u[1],i=e.changeWithinAtom.string,r=e.changeWithinAtom.atom||this.mode.editedAtom(),a.push({changeWithinAtom:{range:[o,o+i.length],string:r.symbol.slice(o,l),atom:r}})),a.push(t),this.groupMutationRegister.stack=c,this.groupMutationRegister.states.push(tn(a))},e.prototype.packGroupMutation=function(){var e,t,n,i;return i=this.groupMutationRegister,t=i.stack,n=i.states,n.reverse(),t.push(this.sameKindMutation(n,t[t.length-1]||[])?e=n.concat(t.pop()):n),this.groupMutationRegister={states:[]}},e.prototype.undo=function(){return this.mode.replay(this.undoStack,{redo:!0})},e.prototype.redo=function(){return this.mode.replay(this.redoStack,{undo:!0})},e.prototype.reset=function(){return this.undoStack=[],this.redoStack=[],this.groupMutationRegister={states:[]}},e.prototype.sameKindMutation=function(e,t){var n,i,r,o,s,a,c,l,u,h,d;return e.length>0&&t.length>0?(r=e[0],i=t[0],(n=null!=(o=r.changeInTree)?o.added[0]:void 0)&&n===(null!=(s=i.changeWithinAtom)?s.atom:void 0)||(n=null!=(a=r.changeWithinAtom)?a.atom:void 0)&&r.changeWithinAtom.string.length>0&&n===(null!=(c=i.changeWithinAtom)?c.atom:void 0)&&i.changeWithinAtom.string.length>0||(n=null!=(l=r.changeWithinAtom)?l.atom:void 0)&&0===r.changeWithinAtom.string.length&&n===(null!=(u=i.changeInTree)?u.at["in"][0]:void 0)||(n=null!=(h=r.changeWithinAtom)?h.atom:void 0)&&0===r.changeWithinAtom.string.length&&n===(null!=(d=i.changeWithinAtom)?d.atom:void 0)&&0===i.changeWithinAtom.string.length):!1},e}(),A=function(e){var t,n,i,r,o,s,a,c,l,u;for(r="xyzwtuvmnopqrs",s=!1,o=0,n={},i=[],t=function(e){var t;return i.push((t=n[e])?(n[e]++,e+t):(n[e]=2,e))},u=ai(e),c=0,l=u.length;l>c;c++)a=u[c],s?s=!1:t(Ot(a)?(s=!0,hi(a)):!Et(a)||Bt(a)||Wt(a)?r[o++]:a.symbol);return i},Vt=function(e){var t;return zt(t=vn(e))?Kt(t):!0},C=function(e){var t;return(t=mn(e))?Kt(t)&&kt(e)?e:C(t):e},pt=function(e,t){return dt(t)||e},dt=function(e){return Mt(e)?e:zt(e.parent)?dt(e.parent):void 0},ht=function(e){var t;return t=ai(e)[0]},st=function(e){var t,n;return n=ai(e),t=n[n.length-1]},xt=function(e){return St(e)&&Mt(pi(e))},Kt=function(e){var t;return Mt(e)||Rt(e)&&"syntax"===(null!=(t=pi(e))?t.symbol:void 0)},Mt=function(e){var t;return Rt(e)&&"fn"===(null!=(t=pi(e))?t.symbol:void 0)},Lt=function(e){var t,n;return!(Rt(e)&&("#"===(t=null!=(n=pi(e))?n.symbol:void 0)||":"===t))},J=function(e){var t,n,i,r,o,s,a,c,l;if(Rt(t=e)){for(o=t.slice(0,2),l=t.slice(2,-1),n=a=0,c=l.length;c>a;n=++a)s=l[n],Gt(s)||(i=t[n-1+2],r=$t(i)?t.slice(n-2+2,n+2):Gt(i)?[i]:[ti(" ")],o.push.apply(o,Si.call(r).concat([J(s)])));return o.push(t[t.length-1]),Qt(o)}return e},K=function(e){var t;return(t=mn(e))?Pt(On(p,t))?t:K(t):void 0},Pt=function(e){return"name"===(null!=e?e.label:void 0)},Nt=function(e){return"keyword"===(null!=e?e.label:void 0)},rt=function(e){return function(t){var n,i,r,o,s;return o=e.length,i=function(){var n,i,a;if(1===o){if(an(e[0],t))return[[t]]}else if(Rt(t)&&t.length>=o){for(a=[],r=n=0,i=t.length-o;i>=0?i>=n:n>=i;r=i>=0?++n:--n)an(s=t.slice(r,r+o),e)&&a.push(s);return a}}(),n=Rt(t)?j(rt(e),t):void 0,Yt(i||[],n||[])}},an=function(e,t){return Rt(e)?Rt(t)&&e.length===t.length&&y(oi(an,e,t)):e.symbol===t.symbol},at=function(e,t){var n,i,r;for(i=0,r=t.length;r>i;i++)if(n=t[i],Pt(n)&&n.symbol===e)return n},D=function(e){return{name:e.symbol,scope:e.scope}},ot=function(e){return function(t){return Rt(t)?j(ot(e),t):t.id===e.id?[t]:[]}},ut=function(e){return function(t){return Rt(t)?j(ut(e),t):t.id===e.id&&t!==e?[t]:[]}},On=function(e,t){var n,i,r,o,s;for(r=vi(t.parent),n=o=0,s=r.length;s>o;n=++o)if(i=r[n],i===t)return e===l?r[n+1]:r[n-1]},it=function(e,t,n){var i,r,o,s;for(e>0?(o=0,s=n.length):o=n.length-1;e>0?s>o:o>=0;o+=e){if(i=n[o],r)return i;(i===t||i[0]&&i[0]===t[0])&&(r=!0)}return G(hn(e),n)},ln=function(e){var t;return t=e["in"][0],1===e["in"].length&&kt(t)?t:void 0},tt=function(e){var t;return t=e.out[0],t.fake?t:void 0},$n=function(e){var t,n,i,r;return t=Zt(si(z,vn),e),n=Math.min.apply(Math,t),i=function(){var t,i,o;for(o=[],t=0,i=e.length;i>t;t++)r=e[t],o.push(Wn(r,z(vn(r))-n));return o}(),Ln(i)},Ln=function(e){var t,n,i,r;for(t=vn(e[0]),i=0,r=e.length;r>i;i++)if(n=e[i],vn(n)!==t)return Ln(Zt(Vn,e));return e},Wn=function(e,t){return 0===t?e:Wn(Vn(e),t-1)},Hn=function(e,t){var n,i,r,o,s;return s=Nn(e,t),n=s[0],o=s[1],r=vn(n),i=on(c,n),{"in":r.slice(M(i),L(o)),out:o.out}},Qn=function(e){var t;return W(nt(ui,[t=qn(p,e),e,t?void 0:qn(d,e)]))},Xn=function(e){return W(nt(ui,[qn(p,e),e,qn(d,e)]))},qn=function(e,t){var n,i;return i=fn(e,t),n=G(e,i),Gt(n)?bt(i):null},Nn=function(e,t){return L(e)>L(t)?[t,e]:[e,t]},Un=function(e,t){var n;return n=G(e,t["in"]),e===l||0===t["in"].length?{"in":!n||Gt(n)?[]:[n],out:t.out}:Gt(n)?{"in":[],out:[n]}:bt([n])},vn=function(e){return e.out[0].parent},L=function(e){return M(e.out[0])},on=function(e,t){return G(e,sn(t))},sn=function(e){var t,n;return t=Yt(e["in"],e.out)[0],n=e.out[0],[t,n]},bt=function(e){var t,n;return t=e[e.length-1],n=Mn(d,t),{"in":e,out:ri(n)}},pn=function(e){return{"in":[],out:ri(e[0])}},W=function(e){var t,n,i;return t=2<=e.length?Si.call(e,0,i=e.length-1):(i=0,[]),n=e[i++],{"in":Yt(j(Yn,t),n["in"]),out:n.out}},Yn=function(e){return e["in"]},ft=function(e,t){var n,i,r;for(i=zn(hn(e),t);(r=kt(n=Zn(i)))&&jt(n,t);)i=mt(e,i);return r?t:i},jt=function(e,t){return e&&(e===t||jt(e.parent,t))},mt=function(e,t){return F(e,Bn(e,on(e,t)))},F=function(e,t){var n;return t?(n=At(t))?n:F(e,Bn(e,t)):void 0},At=function(e){var t;return t=wn(e),(Gt(e)&&!$t(e)||_t(e))&&!_t(t)?{"in":kt(t)?[t]:[],out:ri(e)}:void 0},Vn=function(e){var t;return t=vn(e),zt(t)?bt([t]):void 0},Gn=function(e,t,n){var i,r,o;return o=vt(e,t,n),r=o[0],i=o[1],r===i&&kt(r)?bt([r]):_t(r)?bt([r.parent]):Ht(i)?bt([i.parent]):kt(r)?{"in":[r],out:ri(i)}:kt(i)?bt([i]):Ht(r)||!$t(i)?{"in":[],out:ri(i)}:Kn(e,n)},Kn=function(e,t){var n;return(n=Mn(e,t))&&Gn(e,t,n)},zn=function(e,t){return Un(e,Ct(t))},vt=function(e,t,n){return e===l?[t,n]:[n,t]},Ct=function(e){return{"in":e.slice(1,-1),out:e.slice(-1)}},gn=function(e,t){return G(e,fn(e,t))},fn=function(e,t){return e===l?t.out:Cn(Mn(p,Zn(t)))},yn=function(e){return Zt(function(e){return e()},e)},T=function(e){var t;return t=wn(Zn(e)),function(){return{"in":[],out:ri(gt(t))}}},en=function(e){return 0===e["in"].length?[[e.out[0]],pn]:[e["in"],bt]},Jn=function(e){return kt(e)?ei(e):{"in":[],out:ri(e)}},ei=function(e){return bt([e])},Zn=function(e){return on(c,e)},Cn=function(e){return $t(e)?[Mn(p,e),e]:[e]},ri=function(e){var t;return t=Mn(d,e),Gt(e)&&t&&$t(t)?[e,t]:[e]},Xt=function(e,t){return Rt(t)?Xt(e,G(e,vi(t))):t},z=function(e){return zt(e)?1+z(e.parent):-1},wt=function(e,t,n){return e.parent=t,t.splice(n,0,e)},b=function(e,t){var n,i,r,o,s;for(r=e.out[0].parent,o=0,s=t.length;s>o;o++)i=t[o],i.parent=r;return n=M(on(c,e)),r.splice.apply(r,[n,e["in"].length].concat(Si.call(t)))},w=function(e,t,n){var i,r,o,s;return s=Pn(t),o=s[0],i=s[1],r=i-o,e.symbol=jn(e.symbol,o,r,n),e.end+=n.length-r},E=function(e,t,n){var i,r,o;return o=vt(e,t,n),r=o[0],i=o[1],{"in":Yt(r["in"],i["in"]),out:i.out}},Pn=function(e){var t,n;return t=e[0],n=e[1],[Math.min(t,n),Math.max(t,n)]},cn=function(e){var t,n,i,r;for(n="",i=0,r=e.length;r>i;i++)t=e[i],n+=Rt(t)?cn(t):t.symbol;return n},Q=function(e){return e.symbol.length-(Dt(e)?2:Bt(e)?1:0)},R=function(e,t,n){var i,r,o,s,a;return s=e.length,o=(i=e.indexOf("."))>=0?i+1:s,r=s-o,a=parseFloat(e),a*=Math.pow(10,r),n*=Math.pow(10,s-t-(o!==s&&o>t?1:0)),a+=n,a/=Math.pow(10,r),a.toFixed(r)},kt=function(e){return!Gt(e)&&!Ft(e)},Et=function(e){return kt(e)&&!Rt(e)},Wt=function(e){return e.symbol&&/^-?\d/.test(e.symbol)},Dt=function(e){var t;return"string"===(t=e.label)||"regex"===t},Bt=function(e){return"char"===e.label||Dt(e)},_=function(e){return e.symbol[0]},Ft=function(e){return/^[\(\)\[\]\{\}]$/.test(e.symbol)},_t=function(e){return/^[\)\]\}]$/.test(e.symbol)},Ht=function(e){return/^[\(\[\{]$/.test(e.symbol)},Ut=function(e){var t;return t=mn(e),t&&St(t)&&li(vi(t))===e},Tt=function(e){return 2===e.length&&"("===e[0].symbol},Ot=function(e){return"label"===e.label},Gt=function(e){var t;return"whitespace"===(t=e.label)||"indent"===t},$t=function(e){return"indent"===e.label},qt=function(e){return" "===e.symbol},It=function(e){return"\n"===e.symbol},zt=function(e){return e.start>=0},Z=function(e,t){return t.replace(RegExp(""+e,"g"),"\\"+e)},kn=function(e,t){return new Array(e+1).join(t)},tn=function(e){var t,n,i,r,o,s;for(n={},o=0,s=e.length;s>o;o++){t=e[o];for(i in t)r=t[i],n[i]=r}return n},et=function(e,t){return tn([e,t])},yi=function(e){return e.transformed?yi(e.transformed):e},ct=function(e,t,n){var i;return t<e.end&&e.start<n?t===e.start&&n===e.end?[e]:I(function(){var r,o,s;for(s=[],r=0,o=e.length;o>r;r++)i=e[r],s.push(ct(i,t,n));return s}()):[]},lt=function(e,t,n){var i;return t<e.end&&e.start<n?Rt(e)?I(function(){var r,o,s;for(s=[],r=0,o=e.length;o>r;r++)i=e[r],s.push(lt(i,t,n));return s}()):[e]:[]},H=function(e){var t,n;return t=Zt(U,e),(n=t[t.length-1])&&"\n"===n.value&&t.pop(),t},U=function(e){var t;return t=Ft(e),{value:"string"===e.label?""+e.symbol.slice(1,-1)+"":e.symbol,type:function(){if(t&&e.parent.malformed||!t&&e.malformed)return"token_malformed";switch(e.label){case"whitespace":return"text";default:return e.label?"token_"+e.label:"text"}}()+(e.fake?".token_fake":"")}},ni=function(e){var t;return t=e.slice(1,-1),t.start=e.start+1,t.end=e.end-1,t},V=function(e,t){return e===l?t.end:t.start},X=function(e,t){return Y(e,t)+(Dt(t)?hn(e):0)},Y=function(e,t){return e===l?t.symbol.length:0},G=function(e,t){var n,i;return n=t[0],i=t[t.length-1],e===l?i:n},bn=function(e,t){return f.fromPoints(e,t)},jn=function(e,t,n,i){return e.slice(0,t)+i+e.slice(t+n)},An=function(e){var t,n,i,r;for(n=!1,r=e.parent,i=r.length-1;i>=0;i+=-1){if(t=r[i],n&&kt(t))return t;t===e&&(n=!0)}return e},rn=function(e){var t,n,i,r,o;for(n=!1,o=e.parent,i=0,r=o.length;r>i;i++){if(t=o[i],n&&kt(t))return t;t===e&&(n=!0)}return e},wn=function(t){return Bn(e,t)},gt=function(e){return Bn(l,e)},Bn=function(e,t){var n;return n=Mn(e,t)||zt(t.parent)&&Bn(e,t.parent),n?Rt(n)?G(hn(e),n):n:void 0},mn=function(e){return zt(e.parent)?e.parent:void 0},Mn=function(e,t){return t.parent[M(t)+e]},En=function(e){return e.parent[M(e)-1]},nn=function(e){return e.parent[M(e)+1]},M=function(e){return yt(e,e.parent)},yt=function(e,t){var n,i,r,o;for(i=r=0,o=t.length;o>r;i=++r)if(n=t[i],n===e)return i;throw new Error("what is not inside of array in indexWithin")},q=function(e,t){var n,i,r,o,s;if(t.malformed=e.malformed,t.tea=e.tea,t.id=e.id,t.fake=e.fake,t.assignable=e.assignable,t.scope=e.scope,t.inferredType=e.inferredType,t.imported=e.imported,Rt(e)){for(s=[],n=r=0,o=e.length;o>r;n=++r)i=e[n],s.push(q(i,t[n]));return s}return t.label=e.label},Tn=function(e,t,n){return Fn(e["in"],t,n)},Dn=function(e,t){return _n(e["in"],t)},_n=function(e,t){var n;return n=Fn(e,t,[])[0]},Fn=function(e,t,n){var i,r,o,s,a,c;for(c=N(e,n),i=c[0],o=c[1],s=0,a=i.length;a>s;s++)r=i[s],r.parent=t;return[Sn(i,t),o]},x=function(e,t){var n,i,r,o,s;return o=P.astizeList(e),xn(z(t),o),r=o[0],i=3<=o.length?Si.call(o,1,s=o.length-1):(s=1,[]),n=o[s++],i},O=function(e){var t;return t=N(e,[])[0]},N=function(e,t){var n,i,r;return r=ii(Zt($(t),e)),n=r[0],i=r[1],[n,I(i)]},B=function(e){var t;return t=$([])(e)[0]},$=function(e){return function(t){var n,i,r;return Rt(t)?(r=N(t,e),n=r[0],i=r[1],Qt(n)):(i=[],n={symbol:t.symbol,label:t.label}),n.start=t.start,n.end=t.end,n.malformed=t.malformed,n.tea=t.tea,n.id=t.id,xi.call(e,t)>=0&&(i=[n]),[n,i]}},Sn=function(e,t){return xn(z(t),e),e},xn=function(e,t,n,i){var r,o,s,a,c,l;if(Rt(t))for(r=0;r<t.length;)xn(e+1,t[r],t[r+1],r+1),++r;else n&&It(t)&&(o=kn(e,"  "),c=e>0,$t(n)?c?Rn(n,o):n.parent.splice(i,1):c&&(l=S("\n  "),a=l[0],s=l[1],Rn(s,o),wt(s,n.parent,M(n))))},Qt=function(e){var t,n,i;for(n=0,i=e.length;i>n;n++)t=e[n],t.parent=e;return e},Rn=function(e,t){return e.symbol=t,e.end=e.start+t.length},S=function(e){var t,n,i,r,o;return o=P.astizeExpression("("+e+")"),i=o[0],n=3<=o.length?Si.call(o,1,r=o.length-1):(r=1,[]),t=o[r++],n},h=l=d=1,c=e=p=-1,hn=function(e){return-1*e}});